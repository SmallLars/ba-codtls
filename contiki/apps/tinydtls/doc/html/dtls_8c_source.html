<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>tinydtls: dtls.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">tinydtls
   &#160;<span id="projectnumber">0.3.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">dtls.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="dtls_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* dtls -- a very basic DTLS implementation</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (C) 2011--2012 Olaf Bergmann &lt;bergmann@tzi.org&gt;</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Permission is hereby granted, free of charge, to any person</span>
<a name="l00006"></a>00006 <span class="comment"> * obtaining a copy of this software and associated documentation</span>
<a name="l00007"></a>00007 <span class="comment"> * files (the &quot;Software&quot;), to deal in the Software without</span>
<a name="l00008"></a>00008 <span class="comment"> * restriction, including without limitation the rights to use, copy,</span>
<a name="l00009"></a>00009 <span class="comment"> * modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<a name="l00010"></a>00010 <span class="comment"> * of the Software, and to permit persons to whom the Software is</span>
<a name="l00011"></a>00011 <span class="comment"> * furnished to do so, subject to the following conditions:</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * The above copyright notice and this permission notice shall be</span>
<a name="l00014"></a>00014 <span class="comment"> * included in all copies or substantial portions of the Software.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<a name="l00017"></a>00017 <span class="comment"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a name="l00018"></a>00018 <span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<a name="l00019"></a>00019 <span class="comment"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<a name="l00020"></a>00020 <span class="comment"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<a name="l00021"></a>00021 <span class="comment"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<a name="l00022"></a>00022 <span class="comment"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<a name="l00023"></a>00023 <span class="comment"> * SOFTWARE.</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html">config.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#ifdef HAVE_ASSERT_H</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_TIME_H</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00035"></a><a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">00035</a> <span class="preprocessor">#define clock_time() (time(NULL))</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#ifndef CLOCK_SECOND</span>
<a name="l00037"></a><a class="code" href="dtls_8c.html#ae3ced0551b26c9b99cb45a86f34d100a">00037</a> <span class="preprocessor"></span><span class="preprocessor"># define CLOCK_SECOND 1024</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="uthash_8h.html">uthash.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00044"></a>00044 <span class="preprocessor"># ifndef NDEBUG</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#   define DEBUG DEBUG_PRINT</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#   include &quot;net/uip-debug.h&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#  endif </span><span class="comment">/* NDEBUG */</span>
<a name="l00048"></a>00048 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="numeric_8h.html">numeric.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="netq_8h.html">netq.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="dtls_8h.html" title="High level DTLS API and visible structures.">dtls.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#ifdef WITH_SHA256</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#  include &quot;sha2/sha2.h&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a><a class="code" href="dtls_8c.html#aebefc949b2298e7de7b95b715874d407">00059</a> <span class="preprocessor">#define dtls_set_version(H,V) dtls_int_to_uint16(&amp;(H)-&gt;version, (V))</span>
<a name="l00060"></a><a class="code" href="dtls_8c.html#a8e0ab8b3ce70468c29820cafe96cd365">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define dtls_set_content_type(H,V) ((H)-&gt;content_type = (V) &amp; 0xff)</span>
<a name="l00061"></a><a class="code" href="dtls_8c.html#a9f723101896941fa44ea701c4dfd3591">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define dtls_set_length(H,V)  ((H)-&gt;length = (V))</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="dtls_8c.html#aa02d6b65a8864468c2b8cfbe79084467">00063</a> <span class="preprocessor">#define dtls_get_content_type(H) ((H)-&gt;content_type &amp; 0xff)</span>
<a name="l00064"></a><a class="code" href="dtls_8c.html#a22d6bcdee257de4be562aee0be9c87fb">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define dtls_get_version(H) dtls_uint16_to_int(&amp;(H)-&gt;version)</span>
<a name="l00065"></a><a class="code" href="dtls_8c.html#a175d8e65080497463d13caf20e961500">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define dtls_get_epoch(H) dtls_uint16_to_int(&amp;(H)-&gt;epoch)</span>
<a name="l00066"></a><a class="code" href="dtls_8c.html#a41f28f63e60a1a0b45a77d62bb5380e7">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define dtls_get_sequence_number(H) dtls_uint48_to_ulong(&amp;(H)-&gt;sequence_number)</span>
<a name="l00067"></a><a class="code" href="dtls_8c.html#aad633ed0a80e25b3884d119a8d8aeaff">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define dtls_get_fragment_length(H) dtls_uint24_to_int(&amp;(H)-&gt;fragment_length)</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a>00069 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l00070"></a><a class="code" href="dtls_8c.html#a0ce6e5416f5479558116b881d3eb1ad6">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define HASH_FIND_PEER(head,sess,out)       \</span>
<a name="l00071"></a>00071 <span class="preprocessor">  HASH_FIND(hh,head,sess,sizeof(session_t),out)</span>
<a name="l00072"></a><a class="code" href="dtls_8c.html#acf0d50c9f224c0677988f13e947e9523">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define HASH_ADD_PEER(head,sess,add)        \</span>
<a name="l00073"></a>00073 <span class="preprocessor">  HASH_ADD(hh,head,sess,sizeof(session_t),add)</span>
<a name="l00074"></a><a class="code" href="dtls_8c.html#a0844494b0b76acb7bcf832ae74fb25c0">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define HASH_DEL_PEER(head,delptr)      \</span>
<a name="l00075"></a>00075 <span class="preprocessor">  HASH_DELETE(hh,head,delptr)</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">00078</a> <span class="preprocessor">#define DTLS_RH_LENGTH sizeof(dtls_record_header_t)</span>
<a name="l00079"></a><a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define DTLS_HS_LENGTH sizeof(dtls_handshake_header_t)</span>
<a name="l00080"></a><a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define DTLS_CH_LENGTH sizeof(dtls_client_hello_t) </span><span class="comment">/* no variable length fields! */</span>
<a name="l00081"></a><a class="code" href="dtls_8c.html#a85d3d5311baabdaa06b7824528eef4e5">00081</a> <span class="preprocessor">#define DTLS_HV_LENGTH sizeof(dtls_hello_verify_t)</span>
<a name="l00082"></a><a class="code" href="dtls_8c.html#afcca5dc5ebcc9eb8141ca0b49b647676">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define DTLS_SH_LENGTH (2 + 32 + 1 + 2 + 1)</span>
<a name="l00083"></a><a class="code" href="dtls_8c.html#a6832aa690127f1de63ed04f902869fea">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define DTLS_CKX_LENGTH 1</span>
<a name="l00084"></a><a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define DTLS_FIN_LENGTH 12</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>
<a name="l00086"></a><a class="code" href="dtls_8c.html#a76388c15f1b77d3c5b9d8068e8c0a087">00086</a> <span class="preprocessor">#define HS_HDR_LENGTH  DTLS_RH_LENGTH + DTLS_HS_LENGTH</span>
<a name="l00087"></a><a class="code" href="dtls_8c.html#a07a808dc78df3141fe5caba2a3e2226b">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define HV_HDR_LENGTH  HS_HDR_LENGTH + DTLS_HV_LENGTH</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="dtls_8c.html#aa5a8f0d3793bb3b194ca364b596ab01d">00089</a> <span class="preprocessor">#define HIGH(V) (((V) &gt;&gt; 8) &amp; 0xff)</span>
<a name="l00090"></a><a class="code" href="dtls_8c.html#a69edf0296cf64026686d4ff4424d4e8f">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define LOW(V)  ((V) &amp; 0xff)</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a><a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">00092</a> <span class="preprocessor">#define DTLS_RECORD_HEADER(M) ((dtls_record_header_t *)(M))</span>
<a name="l00093"></a><a class="code" href="dtls_8c.html#a2cc930733d35ea870c7a0a131bee0d7a">00093</a> <span class="preprocessor"></span><span class="preprocessor">#define DTLS_HANDSHAKE_HEADER(M) ((dtls_handshake_header_t *)(M))</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a><a class="code" href="dtls_8c.html#a354c84e6c783c5d0cdbf905c27e77dc4">00095</a> <span class="preprocessor">#define HANDSHAKE(M) ((dtls_handshake_header_t *)((M) + DTLS_RH_LENGTH))</span>
<a name="l00096"></a><a class="code" href="dtls_8c.html#a0800e26c09602d197e929fcc8ba783d5">00096</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENTHELLO(M) ((dtls_client_hello_t *)((M) + HS_HDR_LENGTH))</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="dtls_8c.html#ad9942d72305df29539d43b811c63ceb1">00098</a> <span class="preprocessor">#define IS_HELLOVERIFY(M,L) \</span>
<a name="l00099"></a>00099 <span class="preprocessor">      ((L) &gt;= DTLS_HS_LENGTH + DTLS_HV_LENGTH &amp;&amp; (M)[0] == DTLS_HT_HELLO_VERIFY_REQUEST)</span>
<a name="l00100"></a><a class="code" href="dtls_8c.html#aee5c7389d414d6232602a073b826bdd8">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_SERVERHELLO(M,L) \</span>
<a name="l00101"></a>00101 <span class="preprocessor">      ((L) &gt;= DTLS_HS_LENGTH + 6 &amp;&amp; (M)[0] == DTLS_HT_SERVER_HELLO)</span>
<a name="l00102"></a><a class="code" href="dtls_8c.html#ab2139715e3048a2d25523e09c63031b7">00102</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_SERVERHELLODONE(M,L) \</span>
<a name="l00103"></a>00103 <span class="preprocessor">      ((L) &gt;= DTLS_HS_LENGTH &amp;&amp; (M)[0] == DTLS_HT_SERVER_HELLO_DONE)</span>
<a name="l00104"></a><a class="code" href="dtls_8c.html#afb71c900a4079e4c28675a5e1e05e3ef">00104</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_FINISHED(M,L) \</span>
<a name="l00105"></a>00105 <span class="preprocessor">      ((L) &gt;= DTLS_HS_LENGTH + DTLS_FIN_LENGTH &amp;&amp; (M)[0] == DTLS_HT_FINISHED)</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>
<a name="l00107"></a>00107 <span class="comment">/* The length check here should work because dtls_*_to_int() works on</span>
<a name="l00108"></a>00108 <span class="comment"> * unsigned char. Otherwise, broken messages could cause severe</span>
<a name="l00109"></a>00109 <span class="comment"> * trouble. Note that this macro jumps out of the current program flow</span>
<a name="l00110"></a>00110 <span class="comment"> * when the message is too short. Beware!</span>
<a name="l00111"></a>00111 <span class="comment"> */</span>
<a name="l00112"></a><a class="code" href="dtls_8c.html#a09a0896d586ff27855ced6930cc17023">00112</a> <span class="preprocessor">#define SKIP_VAR_FIELD(P,L,T) {                     \</span>
<a name="l00113"></a>00113 <span class="preprocessor">    if (L &lt; dtls_ ## T ## _to_int(P) + sizeof(T))           \</span>
<a name="l00114"></a>00114 <span class="preprocessor">      goto error;                           \</span>
<a name="l00115"></a>00115 <span class="preprocessor">    L -= dtls_ ## T ## _to_int(P) + sizeof(T);              \</span>
<a name="l00116"></a>00116 <span class="preprocessor">    P += dtls_ ## T ## _to_int(P) + sizeof(T);              \</span>
<a name="l00117"></a>00117 <span class="preprocessor">  }</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>
<a name="l00119"></a><a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">00119</a> <span class="preprocessor">#define CURRENT_CONFIG(Peer) (&amp;(Peer)-&gt;security_params[(Peer)-&gt;config])</span>
<a name="l00120"></a><a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define OTHER_CONFIG(Peer) (&amp;(Peer)-&gt;security_params[!((Peer)-&gt;config &amp; 0x01)])</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="dtls_8c.html#a55a2fb47742a4db5d780fd5bd73bef15">00122</a> <span class="preprocessor">#define SWITCH_CONFIG(Peer) ((Peer)-&gt;config = !((Peer)-&gt;config &amp; 0x01))</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00124"></a><a class="code" href="dtls_8c.html#acc22721464ad8b98f255d11effd68a07">00124</a> <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="dtls_8c.html#acc22721464ad8b98f255d11effd68a07">_clear</a>[DTLS_MAX_BUF]; <span class="comment">/* target buffer message decryption */</span>
<a name="l00125"></a><a class="code" href="dtls_8c.html#acb6354637459cafd38dc3496d17cf6d1">00125</a> <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="dtls_8c.html#acb6354637459cafd38dc3496d17cf6d1">_buf</a>[DTLS_MAX_BUF]; <span class="comment">/* target buffer for several crypto operations */</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *packet, <span class="keywordtype">int</span> length);
<a name="l00129"></a>00129 <span class="keywordtype">void</span> <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>, <span class="keywordtype">size_t</span> len);
<a name="l00130"></a>00130 <span class="preprocessor">#endif</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>
<a name="l00132"></a>00132 <span class="comment">/* some constants for the PRF */</span>
<a name="l00133"></a><a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">00133</a> <span class="preprocessor">#define PRF_LABEL(Label) prf_label_##Label</span>
<a name="l00134"></a><a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">00134</a> <span class="preprocessor"></span><span class="preprocessor">#define PRF_LABEL_SIZE(Label) (sizeof(PRF_LABEL(Label)) - 1)</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>
<a name="l00136"></a><a class="code" href="dtls_8c.html#a784ec579660900e758a9b7de84150c9b">00136</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls_8c.html#a784ec579660900e758a9b7de84150c9b">prf_label_master</a>[] = <span class="stringliteral">&quot;master secret&quot;</span>;
<a name="l00137"></a><a class="code" href="dtls_8c.html#a42886cd9a1fd728f47ea40d38dfabcda">00137</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls_8c.html#a42886cd9a1fd728f47ea40d38dfabcda">prf_label_key</a>[] = <span class="stringliteral">&quot;key expansion&quot;</span>;
<a name="l00138"></a><a class="code" href="dtls_8c.html#abba2a2562813493d98b5671a4c5c082b">00138</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls_8c.html#abba2a2562813493d98b5671a4c5c082b">prf_label_client</a>[] = <span class="stringliteral">&quot;client&quot;</span>;
<a name="l00139"></a><a class="code" href="dtls_8c.html#aacf8643991dec574dcb09a280357ae4f">00139</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls_8c.html#aacf8643991dec574dcb09a280357ae4f">prf_label_server</a>[] = <span class="stringliteral">&quot;server&quot;</span>;
<a name="l00140"></a><a class="code" href="dtls_8c.html#a45d793d73836bf96dacb1d558f81b6c7">00140</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls_8c.html#a45d793d73836bf96dacb1d558f81b6c7">prf_label_finished</a>[] = <span class="stringliteral">&quot; finished&quot;</span>;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="dtls_8c.html#afdd61797fb219931160c5e826b9c40d9">netq_init</a>();
<a name="l00143"></a>00143 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="crypto_8c.html#a86e6ce9d4b4afcef355836955697f52c">crypto_init</a>();
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="dtls_8c.html#add05e8b40c758e1a799a281e20873999">00145</a> <a class="code" href="structdtls__context__t.html">dtls_context_t</a> <a class="code" href="dtls_8c.html#add05e8b40c758e1a799a281e20873999">the_dtls_context</a>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *
<a name="l00149"></a><a class="code" href="dtls_8c.html#a89738cd2081b322562b9893c524fb0e1">00149</a> <a class="code" href="dtls_8c.html#a89738cd2081b322562b9893c524fb0e1">dtls_malloc_peer</a>() {
<a name="l00150"></a>00150   <span class="keywordflow">return</span> (<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a>));
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00154"></a><a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">00154</a> <a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">dtls_free_peer</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l00155"></a>00155   free(peer);
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00158"></a>00158 <a class="code" href="dtls-client_8c.html#a434cd5a68c7ed008fa3ac11a30f27398">PROCESS</a>(dtls_retransmit_process, <span class="stringliteral">&quot;DTLS retransmit process&quot;</span>);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="preprocessor">#include &quot;memb.h&quot;</span>
<a name="l00161"></a>00161 MEMB(peer_storage, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a>, DTLS_PEER_MAX);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *
<a name="l00164"></a>00164 <a class="code" href="dtls_8c.html#a89738cd2081b322562b9893c524fb0e1">dtls_malloc_peer</a>() {
<a name="l00165"></a>00165   <span class="keywordflow">return</span> memb_alloc(&amp;peer_storage);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00168"></a>00168 <a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">dtls_free_peer</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l00169"></a>00169   memb_free(&amp;peer_storage, peer);
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="keywordtype">void</span>
<a name="l00174"></a><a class="code" href="dtls_8h.html#ac203466e393ac9030d405c8f0496e9cd">00174</a> <a class="code" href="dtls_8c.html#ac203466e393ac9030d405c8f0496e9cd">dtls_init</a>() {
<a name="l00175"></a>00175   <a class="code" href="dtls_8c.html#afdd61797fb219931160c5e826b9c40d9">netq_init</a>();
<a name="l00176"></a>00176   <a class="code" href="crypto_8c.html#a86e6ce9d4b4afcef355836955697f52c">crypto_init</a>();
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="preprocessor">#ifdef WITH_CONTIKI</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>  memb_init(&amp;peer_storage);
<a name="l00180"></a>00180 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="comment">/* Calls cb_alert() with given arguments if defined, otherwise an</span>
<a name="l00184"></a>00184 <span class="comment"> * error message is logged and the result is -1. This is just an</span>
<a name="l00185"></a>00185 <span class="comment"> * internal helper.</span>
<a name="l00186"></a>00186 <span class="comment"> */</span>
<a name="l00187"></a><a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">00187</a> <span class="preprocessor">#define CALL(Context, which, ...)                   \</span>
<a name="l00188"></a>00188 <span class="preprocessor">  ((Context)-&gt;h &amp;&amp; (Context)-&gt;h-&gt;which                  \</span>
<a name="l00189"></a>00189 <span class="preprocessor">   ? (Context)-&gt;h-&gt;which((Context), ##__VA_ARGS__)          \</span>
<a name="l00190"></a>00190 <span class="preprocessor">   : -1)</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>
<a name="l00206"></a>00206 <span class="keywordtype">int</span> <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> type,
<a name="l00207"></a>00207           <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="dtls-client_8c.html#ad6994903b3c19997ffcfdccb4431d308">buflen</a>);
<a name="l00208"></a>00208 
<a name="l00212"></a>00212 <span class="keywordtype">void</span> <a class="code" href="dtls_8c.html#a3bcaa90e5f3f58c6b9b9a2466f7c6707">dtls_stop_retransmission</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *context, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *
<a name="l00215"></a><a class="code" href="dtls_8c.html#a4cd69a01bbd9a73ebb2502e2e46d1bba">00215</a> <a class="code" href="dtls_8c.html#a4cd69a01bbd9a73ebb2502e2e46d1bba">dtls_get_peer</a>(<span class="keyword">struct</span> <a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <span class="keyword">const</span> session_t *session) {
<a name="l00216"></a>00216   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *p = NULL;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span>  <a class="code" href="dtls_8c.html#a0ce6e5416f5479558116b881d3eb1ad6">HASH_FIND_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, session, p);
<a name="l00220"></a>00220 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00221"></a>00221   <span class="keywordflow">for</span> (p = <a class="code" href="t__list_8h.html#adb42e31bb4fe0df6ec1aa3494902968d">list_head</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>); p; p = <a class="code" href="t__list_8h.html#ae7f0bdad2409695760ffd8de55b6a99b">list_item_next</a>(p))
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (<a class="code" href="global_8h.html#a72a41dbeec2aa1c999b7f3a38f5b41e5">dtls_session_equals</a>(&amp;p-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, session))
<a name="l00223"></a>00223       <span class="keywordflow">return</span> p;
<a name="l00224"></a>00224 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l00225"></a>00225   
<a name="l00226"></a>00226   <span class="keywordflow">return</span> p;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="keywordtype">int</span>
<a name="l00230"></a><a class="code" href="dtls_8h.html#a4743f51c3197d290fc9a88e1f3a64928">00230</a> <a class="code" href="dtls_8c.html#a1e338587fb19c794c8d19bc2801f2eb2">dtls_write</a>(<span class="keyword">struct</span> <a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00231"></a>00231        session_t *dst, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>, <span class="keywordtype">size_t</span> len) {
<a name="l00232"></a>00232   
<a name="l00233"></a>00233   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer = <a class="code" href="dtls_8c.html#a4cd69a01bbd9a73ebb2502e2e46d1bba">dtls_get_peer</a>(ctx, dst);
<a name="l00234"></a>00234   
<a name="l00235"></a>00235   <span class="keywordflow">if</span> (peer &amp;&amp; peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> == <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a953a6aabd0aff0492df164e79815b122">DTLS_STATE_CONNECTED</a>)
<a name="l00236"></a>00236     <span class="keywordflow">return</span> <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a2e3ff1e96b8b7db8a3648beba35bfd0c">DTLS_CT_APPLICATION_DATA</a>, buf, len);
<a name="l00237"></a>00237   <span class="keywordflow">else</span>
<a name="l00238"></a>00238     <span class="keywordflow">return</span> peer ? 0 : -1;
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="keywordtype">int</span>
<a name="l00242"></a><a class="code" href="dtls_8h.html#a32222638f549a215ca32f55aac693a54">00242</a> <a class="code" href="dtls_8c.html#a556258e206cde802d1f9668dc5c1cebc">dtls_get_cookie</a>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *msg, <span class="keywordtype">int</span> msglen, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> **cookie) {
<a name="l00243"></a>00243   <span class="comment">/* To access the cookie, we have to determine the session id&#39;s</span>
<a name="l00244"></a>00244 <span class="comment">   * length and skip the whole thing. */</span>
<a name="l00245"></a>00245   <span class="keywordflow">if</span> (msglen &lt; <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">DTLS_CH_LENGTH</a> + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>)
<a name="l00246"></a>00246       || <a class="code" href="numeric_8h.html#a206397ac4e04dc6b880ca9bd3b9714ea">dtls_uint16_to_int</a>(msg + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>) != <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>)
<a name="l00247"></a>00247     <span class="keywordflow">return</span> -1;
<a name="l00248"></a>00248   msglen -= <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">DTLS_CH_LENGTH</a>;
<a name="l00249"></a>00249   msg += <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">DTLS_CH_LENGTH</a>;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <a class="code" href="dtls_8c.html#a09a0896d586ff27855ced6930cc17023">SKIP_VAR_FIELD</a>(msg, msglen, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>); <span class="comment">/* skip session id */</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   <span class="keywordflow">if</span> (msglen &lt; (*msg &amp; 0xff) + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>))
<a name="l00254"></a>00254     <span class="keywordflow">return</span> -1;
<a name="l00255"></a>00255   
<a name="l00256"></a>00256   *cookie = msg + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00257"></a>00257   <span class="keywordflow">return</span> <a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(msg);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259  error:
<a name="l00260"></a>00260   <span class="keywordflow">return</span> -1;
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="keywordtype">int</span>
<a name="l00264"></a><a class="code" href="dtls_8c.html#a928ab886aac9d1b11b6b0e5765be0860">00264</a> <a class="code" href="dtls_8c.html#a928ab886aac9d1b11b6b0e5765be0860">dtls_create_cookie</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00265"></a>00265            session_t *session,
<a name="l00266"></a>00266            <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *msg, <span class="keywordtype">int</span> msglen,
<a name="l00267"></a>00267            <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *cookie, <span class="keywordtype">int</span> *clen) {
<a name="l00268"></a>00268   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>[<a class="code" href="group__HMAC.html#ga3e84ddbef6bf0084252e16e6c547e332">DTLS_HMAC_MAX</a>];
<a name="l00269"></a>00269   <span class="keywordtype">size_t</span> len, e;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271   <span class="comment">/* create cookie with HMAC-SHA256 over:</span>
<a name="l00272"></a>00272 <span class="comment">   * - SECRET</span>
<a name="l00273"></a>00273 <span class="comment">   * - session parameters (only IP address?)</span>
<a name="l00274"></a>00274 <span class="comment">   * - client version </span>
<a name="l00275"></a>00275 <span class="comment">   * - random gmt and bytes</span>
<a name="l00276"></a>00276 <span class="comment">   * - session id</span>
<a name="l00277"></a>00277 <span class="comment">   * - cipher_suites </span>
<a name="l00278"></a>00278 <span class="comment">   * - compression method</span>
<a name="l00279"></a>00279 <span class="comment">   */</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   <span class="comment">/* We use our own buffer as hmac_context instead of a dynamic buffer</span>
<a name="l00282"></a>00282 <span class="comment">   * created by dtls_hmac_new() to separate storage space for cookie</span>
<a name="l00283"></a>00283 <span class="comment">   * creation from storage that is used in real sessions. Note that</span>
<a name="l00284"></a>00284 <span class="comment">   * the buffer size must fit with the default hash algorithm (see</span>
<a name="l00285"></a>00285 <span class="comment">   * implementation of dtls_hmac_context_new()). */</span>
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <a class="code" href="structdtls__hmac__context__t.html">dtls_hmac_context_t</a> hmac_context;
<a name="l00288"></a>00288   <a class="code" href="group__HMAC.html#gaa1eb35fcb2c2eb69eebaefa8eb4a790d">dtls_hmac_init</a>(&amp;hmac_context, ctx-&gt;<a class="code" href="structdtls__context__t.html#adb7dc6a53a7e00f2c4bbf726973e002f">cookie_secret</a>, <a class="code" href="dtls_8h.html#a44ec206b1d84aa3d83281a92ed7cc238">DTLS_COOKIE_SECRET_LENGTH</a>);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290   <a class="code" href="group__HMAC.html#ga1ef9c88a0a2053b442413a9cea3deb73">dtls_hmac_update</a>(&amp;hmac_context, 
<a name="l00291"></a>00291            (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;session-&gt;addr, session-&gt;size);
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <span class="comment">/* feed in the beginning of the Client Hello up to and including the</span>
<a name="l00294"></a>00294 <span class="comment">     session id */</span>
<a name="l00295"></a>00295   e = <span class="keyword">sizeof</span>(<a class="code" href="structdtls__client__hello__t.html">dtls_client_hello_t</a>);
<a name="l00296"></a>00296   e += (*(msg + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + e) &amp; 0xff) + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <a class="code" href="group__HMAC.html#ga1ef9c88a0a2053b442413a9cea3deb73">dtls_hmac_update</a>(&amp;hmac_context, msg + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>, e);
<a name="l00299"></a>00299   
<a name="l00300"></a>00300   <span class="comment">/* skip cookie bytes and length byte */</span>
<a name="l00301"></a>00301   e += *(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *)(msg + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + e) &amp; 0xff;
<a name="l00302"></a>00302   e += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   <a class="code" href="group__HMAC.html#ga1ef9c88a0a2053b442413a9cea3deb73">dtls_hmac_update</a>(&amp;hmac_context, 
<a name="l00305"></a>00305            msg + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + e,
<a name="l00306"></a>00306            <a class="code" href="dtls_8c.html#aad633ed0a80e25b3884d119a8d8aeaff">dtls_get_fragment_length</a>(<a class="code" href="dtls_8c.html#a2cc930733d35ea870c7a0a131bee0d7a">DTLS_HANDSHAKE_HEADER</a>(msg)) - e);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   len = <a class="code" href="group__HMAC.html#gab98c992f3f9cc3c2d75077ddd46049bf">dtls_hmac_finalize</a>(&amp;hmac_context, buf);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="keywordflow">if</span> (len &lt; *clen) {
<a name="l00311"></a>00311     memset(cookie + len, 0, *clen - len);
<a name="l00312"></a>00312     *clen = len;
<a name="l00313"></a>00313   }
<a name="l00314"></a>00314   
<a name="l00315"></a>00315   memcpy(cookie, buf, *clen);
<a name="l00316"></a>00316   <span class="keywordflow">return</span> 1;
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="preprocessor">#ifdef DTLS_CHECK_CONTENTTYPE</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span><span class="comment">/* used to check if a received datagram contains a DTLS message */</span>
<a name="l00321"></a>00321 <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span> content_types[] = { 
<a name="l00322"></a>00322   <a class="code" href="dtls_8h.html#a3114c327a12e3850e97c4cf8a0cc5c9d">DTLS_CT_CHANGE_CIPHER_SPEC</a>,
<a name="l00323"></a>00323   <a class="code" href="dtls_8h.html#af8ce2230240b6d3c36b216ef459baff1">DTLS_CT_ALERT</a>,
<a name="l00324"></a>00324   <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>,
<a name="l00325"></a>00325   <a class="code" href="dtls_8h.html#a2e3ff1e96b8b7db8a3648beba35bfd0c">DTLS_CT_APPLICATION_DATA</a>,
<a name="l00326"></a>00326   0                 <span class="comment">/* end marker */</span>
<a name="l00327"></a>00327 };
<a name="l00328"></a>00328 <span class="preprocessor">#endif</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span>
<a name="l00334"></a>00334 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00335"></a><a class="code" href="dtls_8c.html#a6ecde1c9d9b4ad41fe6a0b793e205fd2">00335</a> <a class="code" href="dtls_8c.html#a6ecde1c9d9b4ad41fe6a0b793e205fd2">is_record</a>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *msg, <span class="keywordtype">int</span> msglen) {
<a name="l00336"></a>00336   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rlen = 0;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="keywordflow">if</span> (msglen &gt;= <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>  <span class="comment">/* FIXME allow empty records? */</span>
<a name="l00339"></a>00339 #ifdef DTLS_CHECK_CONTENTTYPE
<a name="l00340"></a>00340       &amp;&amp; strchr(content_types, msg[0])
<a name="l00341"></a>00341 #endif
<a name="l00342"></a>00342       &amp;&amp; msg[1] == <a class="code" href="dtls_8c.html#aa5a8f0d3793bb3b194ca364b596ab01d">HIGH</a>(<a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>)
<a name="l00343"></a>00343       &amp;&amp; msg[2] == <a class="code" href="dtls_8c.html#a69edf0296cf64026686d4ff4424d4e8f">LOW</a>(<a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>)) 
<a name="l00344"></a>00344     {
<a name="l00345"></a>00345       rlen = <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a> + 
<a name="l00346"></a>00346     <a class="code" href="numeric_8h.html#a206397ac4e04dc6b880ca9bd3b9714ea">dtls_uint16_to_int</a>(<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(msg)-&gt;length);
<a name="l00347"></a>00347       
<a name="l00348"></a>00348       <span class="comment">/* we do not accept wrong length field in record header */</span>
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (rlen &gt; msglen)    
<a name="l00350"></a>00350     rlen = 0;
<a name="l00351"></a>00351   } 
<a name="l00352"></a>00352   
<a name="l00353"></a>00353   <span class="keywordflow">return</span> rlen;
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00362"></a>00362 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *
<a name="l00363"></a><a class="code" href="dtls_8c.html#adf3dc70178c98b927d619776e34ad65e">00363</a> <a class="code" href="dtls_8c.html#adf3dc70178c98b927d619776e34ad65e">dtls_set_record_header</a>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> type, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>) {
<a name="l00364"></a>00364   
<a name="l00365"></a>00365   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(buf, type);
<a name="l00366"></a>00366   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(buf, <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>);
<a name="l00369"></a>00369   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="keywordflow">if</span> (peer) {
<a name="l00372"></a>00372     memcpy(buf, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a9426209cc86fd29402a88fe008a0bc22">epoch</a>, <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>) + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a0749f1df578b26eccab986b0d8abaa56">uint48</a>));
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="comment">/* increment record sequence counter by 1 */</span>
<a name="l00375"></a>00375     <a class="code" href="numeric_8h.html#a33d63fda9a3a1dd5b5535bbbf22f04d0">inc_uint</a>(<a class="code" href="global_8h.html#a0749f1df578b26eccab986b0d8abaa56">uint48</a>, peer-&gt;<a class="code" href="structdtls__peer__t.html#a5333b55b412ed9a5b0364f5d28d956da">rseq</a>);
<a name="l00376"></a>00376   } <span class="keywordflow">else</span> {
<a name="l00377"></a>00377     memset(buf, 0, <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>) + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a0749f1df578b26eccab986b0d8abaa56">uint48</a>));
<a name="l00378"></a>00378   }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>) + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a0749f1df578b26eccab986b0d8abaa56">uint48</a>);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382   memset(buf, 0, <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>));
<a name="l00383"></a>00383   <span class="keywordflow">return</span> buf + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00392"></a>00392 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *
<a name="l00393"></a><a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">00393</a> <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> type, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, 
<a name="l00394"></a>00394               <span class="keywordtype">int</span> length, 
<a name="l00395"></a>00395               <span class="keywordtype">int</span> frag_offset, <span class="keywordtype">int</span> frag_length, 
<a name="l00396"></a>00396               <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>) {
<a name="l00397"></a>00397   
<a name="l00398"></a>00398   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(buf, type);
<a name="l00399"></a>00399   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   <a class="code" href="numeric_8h.html#a9b9d297c93b4ae9b650cea11728b466e">dtls_int_to_uint24</a>(buf, length);
<a name="l00402"></a>00402   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#aabc56baaf04f922a1ea0dda7691fec0a">uint24</a>);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   <span class="keywordflow">if</span> (peer) {
<a name="l00405"></a>00405     <span class="comment">/* increment handshake message sequence counter by 1 */</span>
<a name="l00406"></a>00406     <a class="code" href="numeric_8h.html#a33d63fda9a3a1dd5b5535bbbf22f04d0">inc_uint</a>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>, peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#aeacc505dbea0df588529f9bd31ec0bfd">mseq</a>);
<a name="l00407"></a>00407   
<a name="l00408"></a>00408     <span class="comment">/* and copy the result to buf */</span>
<a name="l00409"></a>00409     memcpy(buf, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#aeacc505dbea0df588529f9bd31ec0bfd">mseq</a>, <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>));
<a name="l00410"></a>00410   } <span class="keywordflow">else</span> {
<a name="l00411"></a>00411     memset(buf, 0, <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>));    
<a name="l00412"></a>00412   }
<a name="l00413"></a>00413   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00414"></a>00414   
<a name="l00415"></a>00415   <a class="code" href="numeric_8h.html#a9b9d297c93b4ae9b650cea11728b466e">dtls_int_to_uint24</a>(buf, frag_offset);
<a name="l00416"></a>00416   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#aabc56baaf04f922a1ea0dda7691fec0a">uint24</a>);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <a class="code" href="numeric_8h.html#a9b9d297c93b4ae9b650cea11728b466e">dtls_int_to_uint24</a>(buf, frag_length);
<a name="l00419"></a>00419   buf += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#aabc56baaf04f922a1ea0dda7691fec0a">uint24</a>);
<a name="l00420"></a>00420   
<a name="l00421"></a>00421   <span class="keywordflow">return</span> <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>;
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423   
<a name="l00439"></a>00439 <span class="keywordtype">int</span>
<a name="l00440"></a><a class="code" href="dtls_8c.html#ae33d80799a71860bb4399853ea4c3093">00440</a> <a class="code" href="dtls_8c.html#ae33d80799a71860bb4399853ea4c3093">dtls_verify_peer</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00441"></a>00441          <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, 
<a name="l00442"></a>00442          session_t *session,
<a name="l00443"></a>00443          <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *record, 
<a name="l00444"></a>00444          <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="keywordtype">int</span> len = <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a>;
<a name="l00447"></a>00447   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *cookie, *p;
<a name="l00448"></a>00448 <span class="preprocessor">#undef mycookie</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span><span class="preprocessor">#define mycookie (ctx-&gt;sendbuf + HV_HDR_LENGTH)</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>
<a name="l00451"></a>00451   <span class="comment">/* check if we can access at least all fields from the handshake header */</span>
<a name="l00452"></a>00452   <span class="keywordflow">if</span> (record[0] == <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>
<a name="l00453"></a>00453       &amp;&amp; data_length &gt;= <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> 
<a name="l00454"></a>00454       &amp;&amp; data[0] == <a class="code" href="dtls_8h.html#a25f0afef67a1fd8d9e3e61074d11e2f5">DTLS_HT_CLIENT_HELLO</a>) {
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">/* Store cookie where we can reuse it for the HelloVerify request. */</span>
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a928ab886aac9d1b11b6b0e5765be0860">dtls_create_cookie</a>(ctx, session, data, data_length,
<a name="l00458"></a>00458                <a class="code" href="dtls_8c.html#a97496e1be0f2fe54873b35ee8bf0d462">mycookie</a>, &amp;len) &lt; 0)
<a name="l00459"></a>00459       <span class="keywordflow">return</span> -1;
<a name="l00460"></a>00460 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>    <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;create cookie: &quot;</span>);
<a name="l00462"></a>00462     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="dtls_8c.html#a97496e1be0f2fe54873b35ee8bf0d462">mycookie</a>, len);
<a name="l00463"></a>00463     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00464"></a>00464 <span class="preprocessor">#endif</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span>    assert(len == <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a>);
<a name="l00466"></a>00466     
<a name="l00467"></a>00467     <span class="comment">/* Perform cookie check. */</span>
<a name="l00468"></a>00468     len = <a class="code" href="dtls_8c.html#a556258e206cde802d1f9668dc5c1cebc">dtls_get_cookie</a>(data, data_length, &amp;cookie);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>    <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;compare with cookie: &quot;</span>);
<a name="l00472"></a>00472     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(cookie, len);
<a name="l00473"></a>00473     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00474"></a>00474 <span class="preprocessor">#endif</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>
<a name="l00476"></a>00476     <span class="comment">/* check if cookies match */</span>
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (len == <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a> &amp;&amp; memcmp(cookie, <a class="code" href="dtls_8c.html#a97496e1be0f2fe54873b35ee8bf0d462">mycookie</a>, len) == 0) {
<a name="l00478"></a>00478     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;found matching cookie\n&quot;</span>);
<a name="l00479"></a>00479       <span class="keywordflow">return</span> 1;      
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l00483"></a>00483       <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;invalid cookie:&quot;</span>);
<a name="l00484"></a>00484       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(cookie, len);
<a name="l00485"></a>00485       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00486"></a>00486     } <span class="keywordflow">else</span> {
<a name="l00487"></a>00487       <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;cookie len is 0!\n&quot;</span>);
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489 <span class="preprocessor">#endif</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span>    <span class="comment">/* ClientHello did not contain any valid cookie, hence we send a</span>
<a name="l00491"></a>00491 <span class="comment">     * HelloVerify request. */</span>
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#ab04f98f1863c785fabd97925c9746f7d">DTLS_HT_HELLO_VERIFY_REQUEST</a>,
<a name="l00494"></a>00494                   peer, <a class="code" href="dtls_8c.html#a85d3d5311baabdaa06b7824528eef4e5">DTLS_HV_LENGTH</a> + <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a>,
<a name="l00495"></a>00495                   0, <a class="code" href="dtls_8c.html#a85d3d5311baabdaa06b7824528eef4e5">DTLS_HV_LENGTH</a> + <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a>, 
<a name="l00496"></a>00496                   ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a> + <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>);
<a name="l00499"></a>00499     p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a>);
<a name="l00502"></a>00502     p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     assert(p == <a class="code" href="dtls_8c.html#a97496e1be0f2fe54873b35ee8bf0d462">mycookie</a>);
<a name="l00505"></a>00505     
<a name="l00506"></a>00506     p += <a class="code" href="dtls_8h.html#a09e4f571633bdb724236ac68459715b6">DTLS_COOKIE_LENGTH</a>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <span class="keywordflow">if</span> (!peer) {
<a name="l00509"></a>00509       <span class="comment">/* It&#39;s an initial ClientHello, so we set the record header</span>
<a name="l00510"></a>00510 <span class="comment">       * manually and send the HelloVerify request using the</span>
<a name="l00511"></a>00511 <span class="comment">       * registered write callback. */</span>
<a name="l00512"></a>00512 
<a name="l00513"></a>00513       <a class="code" href="dtls_8c.html#adf3dc70178c98b927d619776e34ad65e">dtls_set_record_header</a>(<a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, NULL, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l00514"></a>00514       <span class="comment">/* set packet length */</span>
<a name="l00515"></a>00515       <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a> + 11, 
<a name="l00516"></a>00516              p - (ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a> + <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>));
<a name="l00517"></a>00517 
<a name="l00518"></a>00518       (void)<a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, write, session, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l00519"></a>00519     } <span class="keywordflow">else</span> {
<a name="l00520"></a>00520       <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structdtls__peer__t.html#a9426209cc86fd29402a88fe008a0bc22">epoch</a>) {
<a name="l00521"></a>00521     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;renegotiation, therefore we accept it anyway:&quot;</span>);
<a name="l00522"></a>00522     <span class="keywordflow">return</span> 1;
<a name="l00523"></a>00523       }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525       <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l00526"></a>00526             ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a> + <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>, 
<a name="l00527"></a>00527             p - (ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a> + <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>)) &lt; 0) {
<a name="l00528"></a>00528     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot send HelloVerify request\n&quot;</span>);
<a name="l00529"></a>00529     <span class="keywordflow">return</span> -1;
<a name="l00530"></a>00530       }
<a name="l00531"></a>00531   }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="keywordflow">return</span> 0; <span class="comment">/* HelloVerify is sent, now we cannot do anything but wait */</span>
<a name="l00534"></a>00534   }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536   <span class="keywordflow">return</span> -1;            <span class="comment">/* not a ClientHello, signal error */</span>
<a name="l00537"></a>00537 <span class="preprocessor">#undef mycookie</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span>}
<a name="l00539"></a>00539 
<a name="l00541"></a><a class="code" href="dtls_8c.html#ae35671d94ccea5f335546ce409aed601">00541</a> <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="dtls_8c.html#ae35671d94ccea5f335546ce409aed601">compression_methods</a>[] = { 
<a name="l00542"></a>00542   <a class="code" href="dtls_8h.html#a9b0d69c07ce606ae4293939acd07be47">TLS_COMP_NULL</a> 
<a name="l00543"></a>00543 };
<a name="l00544"></a>00544 
<a name="l00552"></a>00552 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00553"></a><a class="code" href="dtls_8c.html#ac913eade769e02601effc0b588fa0693">00553</a> <a class="code" href="dtls_8c.html#ac913eade769e02601effc0b588fa0693">known_cipher</a>(<a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59b">dtls_cipher_t</a> code) {
<a name="l00554"></a>00554   <span class="keywordflow">return</span> code == <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59ba39a3062f136db88f648ce514a591fac8">TLS_PSK_WITH_AES_128_CCM_8</a>;
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 <span class="keywordtype">int</span>
<a name="l00558"></a><a class="code" href="dtls_8c.html#a114248a98717ac20854472dcfd45ea16">00558</a> <a class="code" href="dtls_8c.html#a114248a98717ac20854472dcfd45ea16">calculate_key_block</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00559"></a>00559             <a class="code" href="structdtls__security__parameters__t.html">dtls_security_parameters_t</a> *config,
<a name="l00560"></a>00560             <span class="keyword">const</span> <a class="code" href="structdtls__key__t.html">dtls_key_t</a> *key,
<a name="l00561"></a>00561             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> client_random[32],
<a name="l00562"></a>00562             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> server_random[32]) {
<a name="l00563"></a>00563   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pre_master_secret;
<a name="l00564"></a>00564   <span class="keywordtype">size_t</span> pre_master_len = 0;
<a name="l00565"></a>00565   pre_master_secret = config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a1c3a56ea4af8ff71e1ffe77221541f4d">key_block</a>;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   assert(key);
<a name="l00568"></a>00568   <span class="keywordflow">switch</span> (key-&gt;<a class="code" href="structdtls__key__t.html#a15298324dc6d5cb15a412d0fff3f99a2">type</a>) {
<a name="l00569"></a>00569   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#a32d8ede1d6b5ee6eb1fc32e101743ab9a6a96b075c28b3c167a1a238a33103e17">DTLS_KEY_PSK</a>: {
<a name="l00570"></a>00570   <span class="comment">/* Temporarily use the key_block storage space for the pre master secret. */</span>
<a name="l00571"></a>00571     pre_master_len = <a class="code" href="crypto_8c.html#af9e1d4aeb55b8367dd1c87a665165bef">dtls_pre_master_secret</a>(key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.key, key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.key_length, 
<a name="l00572"></a>00572                       pre_master_secret);
<a name="l00573"></a>00573     
<a name="l00574"></a>00574     <span class="keywordflow">break</span>;
<a name="l00575"></a>00575   }
<a name="l00576"></a>00576   <span class="keywordflow">default</span>:
<a name="l00577"></a>00577     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;calculate_key_block: unknown key type\n&quot;</span>);
<a name="l00578"></a>00578     <span class="keywordflow">return</span> 0;
<a name="l00579"></a>00579   }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>  {
<a name="l00583"></a>00583     <span class="keywordtype">int</span> i;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     printf(<span class="stringliteral">&quot;client_random:&quot;</span>);
<a name="l00586"></a>00586     <span class="keywordflow">for</span> (i = 0; i &lt; 32; ++i)
<a name="l00587"></a>00587       printf(<span class="stringliteral">&quot; %02x&quot;</span>, client_random[i]);
<a name="l00588"></a>00588     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     printf(<span class="stringliteral">&quot;server_random:&quot;</span>);
<a name="l00591"></a>00591     <span class="keywordflow">for</span> (i = 0; i &lt; 32; ++i)
<a name="l00592"></a>00592       printf(<span class="stringliteral">&quot; %02x&quot;</span>, server_random[i]);
<a name="l00593"></a>00593     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     printf(<span class="stringliteral">&quot;psk: (%lu bytes):&quot;</span>, key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.key_length);
<a name="l00596"></a>00596     <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.key, key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.key_length);
<a name="l00597"></a>00597     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     printf(<span class="stringliteral">&quot;pre_master_secret: (%lu bytes):&quot;</span>, pre_master_len);
<a name="l00600"></a>00600     <span class="keywordflow">for</span> (i = 0; i &lt; pre_master_len; ++i)
<a name="l00601"></a>00601       printf(<span class="stringliteral">&quot; %02x&quot;</span>, pre_master_secret[i]);
<a name="l00602"></a>00602     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00603"></a>00603   }
<a name="l00604"></a>00604 <span class="preprocessor">#endif </span><span class="comment">/* NDEBUG */</span>
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   <a class="code" href="crypto_8c.html#a5e47576e502b5a6255f1b489a4915512">dtls_prf</a>(pre_master_secret, pre_master_len,
<a name="l00607"></a>00607        <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(master), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(master),
<a name="l00608"></a>00608        client_random, 32,
<a name="l00609"></a>00609        server_random, 32,
<a name="l00610"></a>00610        config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a0596dc0f5a86433b31dce1746d8c479c">master_secret</a>, 
<a name="l00611"></a>00611        <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span>  {
<a name="l00615"></a>00615     <span class="keywordtype">int</span> i;
<a name="l00616"></a>00616     printf(<span class="stringliteral">&quot;master_secret (%d bytes):&quot;</span>, <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>);
<a name="l00617"></a>00617     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>; ++i)
<a name="l00618"></a>00618       printf(<span class="stringliteral">&quot; %02x&quot;</span>, config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a0596dc0f5a86433b31dce1746d8c479c">master_secret</a>[i]);
<a name="l00619"></a>00619     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00620"></a>00620   }
<a name="l00621"></a>00621 <span class="preprocessor">#endif </span><span class="comment">/* NDEBUG */</span>
<a name="l00622"></a>00622 
<a name="l00623"></a>00623   <span class="comment">/* create key_block from master_secret</span>
<a name="l00624"></a>00624 <span class="comment">   * key_block = PRF(master_secret,</span>
<a name="l00625"></a>00625 <span class="comment">                    &quot;key expansion&quot; + server_random + client_random) */</span>
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <a class="code" href="crypto_8c.html#a5e47576e502b5a6255f1b489a4915512">dtls_prf</a>(config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a0596dc0f5a86433b31dce1746d8c479c">master_secret</a>, 
<a name="l00628"></a>00628        <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>,
<a name="l00629"></a>00629        <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(key), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(key),
<a name="l00630"></a>00630        server_random, 32,
<a name="l00631"></a>00631        client_random, 32,
<a name="l00632"></a>00632        config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a1c3a56ea4af8ff71e1ffe77221541f4d">key_block</a>,
<a name="l00633"></a>00633        <a class="code" href="crypto_8h.html#a1123efcc51d0c4ceca08a6455d46a0ea">dtls_kb_size</a>(config));
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00636"></a>00636 <span class="preprocessor"></span>  {
<a name="l00637"></a>00637       printf(<span class="stringliteral">&quot;key_block (%d bytes):\n&quot;</span>, <a class="code" href="crypto_8h.html#a1123efcc51d0c4ceca08a6455d46a0ea">dtls_kb_size</a>(config));
<a name="l00638"></a>00638       printf(<span class="stringliteral">&quot;  client_MAC_secret:\t&quot;</span>);  
<a name="l00639"></a>00639       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#abb723551bf728433828e0d1607bd6b70">dtls_kb_client_mac_secret</a>(config), 
<a name="l00640"></a>00640        <a class="code" href="crypto_8h.html#aa785c77dbbf8ea9ea470596362b312ca">dtls_kb_mac_secret_size</a>(config));
<a name="l00641"></a>00641       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643       printf(<span class="stringliteral">&quot;  server_MAC_secret:\t&quot;</span>);  
<a name="l00644"></a>00644       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#aed57fa56db7842c9275111bd995f5ae8">dtls_kb_server_mac_secret</a>(config), 
<a name="l00645"></a>00645        <a class="code" href="crypto_8h.html#aa785c77dbbf8ea9ea470596362b312ca">dtls_kb_mac_secret_size</a>(config));
<a name="l00646"></a>00646       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648       printf(<span class="stringliteral">&quot;  client_write_key:\t&quot;</span>);  
<a name="l00649"></a>00649       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a6a0f72fd69e56203b009228bf6de2e86">dtls_kb_client_write_key</a>(config), 
<a name="l00650"></a>00650        <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(config));
<a name="l00651"></a>00651       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653       printf(<span class="stringliteral">&quot;  server_write_key:\t&quot;</span>);  
<a name="l00654"></a>00654       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#ab6a59d24d58d19406e1913c110b4fc59">dtls_kb_server_write_key</a>(config), 
<a name="l00655"></a>00655        <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(config));
<a name="l00656"></a>00656       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658       printf(<span class="stringliteral">&quot;  client_IV:\t\t&quot;</span>);  
<a name="l00659"></a>00659       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a101af9642b17c1c3bbc804fdf9793e29">dtls_kb_client_iv</a>(config), 
<a name="l00660"></a>00660        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(config));
<a name="l00661"></a>00661       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00662"></a>00662       
<a name="l00663"></a>00663       printf(<span class="stringliteral">&quot;  server_IV:\t\t&quot;</span>);  
<a name="l00664"></a>00664       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#acdbb2c30f60673e98d973412fde5aed3">dtls_kb_server_iv</a>(config), 
<a name="l00665"></a>00665        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(config));
<a name="l00666"></a>00666       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00667"></a>00667       
<a name="l00668"></a>00668 
<a name="l00669"></a>00669   }
<a name="l00670"></a>00670 <span class="preprocessor">#endif</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 1;
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00687"></a>00687 <span class="keywordtype">int</span>
<a name="l00688"></a><a class="code" href="dtls_8c.html#a84609d3e600abbd6056ead84b7dbd8d9">00688</a> <a class="code" href="dtls_8c.html#a84609d3e600abbd6056ead84b7dbd8d9">dtls_update_parameters</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00689"></a>00689                <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l00690"></a>00690                <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l00691"></a>00691   <span class="keywordtype">int</span> i, j;
<a name="l00692"></a>00692   <span class="keywordtype">int</span> ok;
<a name="l00693"></a>00693   <a class="code" href="structdtls__security__parameters__t.html">dtls_security_parameters_t</a> *config = <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer);
<a name="l00694"></a>00694 
<a name="l00695"></a>00695   assert(config);
<a name="l00696"></a>00696   assert(data_length &gt; <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">DTLS_CH_LENGTH</a>);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698   <span class="comment">/* debug(&quot;dtls_update_parameters: msglen is %d\n&quot;, data_length); */</span>
<a name="l00699"></a>00699 
<a name="l00700"></a>00700   <span class="comment">/* skip the handshake header and client version information */</span>
<a name="l00701"></a>00701   data += <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00702"></a>00702   data_length -= <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   <span class="comment">/* store client random in config </span>
<a name="l00705"></a>00705 <span class="comment">   * FIXME: if we send the ServerHello here, we do not need to store</span>
<a name="l00706"></a>00706 <span class="comment">   * the client&#39;s random bytes */</span>
<a name="l00707"></a>00707   memcpy(config-&gt;<a class="code" href="structdtls__security__parameters__t.html#af248d67973eb4dd26f36e191ce92a381">client_random</a>, data, <span class="keyword">sizeof</span>(config-&gt;<a class="code" href="structdtls__security__parameters__t.html#af248d67973eb4dd26f36e191ce92a381">client_random</a>));
<a name="l00708"></a>00708   data += <span class="keyword">sizeof</span>(config-&gt;<a class="code" href="structdtls__security__parameters__t.html#af248d67973eb4dd26f36e191ce92a381">client_random</a>);
<a name="l00709"></a>00709   data_length -= <span class="keyword">sizeof</span>(config-&gt;<a class="code" href="structdtls__security__parameters__t.html#af248d67973eb4dd26f36e191ce92a381">client_random</a>);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711   <span class="comment">/* Caution: SKIP_VAR_FIELD may jump to error: */</span>
<a name="l00712"></a>00712   <a class="code" href="dtls_8c.html#a09a0896d586ff27855ced6930cc17023">SKIP_VAR_FIELD</a>(data, data_length, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>); <span class="comment">/* skip session id */</span>
<a name="l00713"></a>00713   <a class="code" href="dtls_8c.html#a09a0896d586ff27855ced6930cc17023">SKIP_VAR_FIELD</a>(data, data_length, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>); <span class="comment">/* skip cookie */</span>
<a name="l00714"></a>00714 
<a name="l00715"></a>00715   i = <a class="code" href="numeric_8h.html#a206397ac4e04dc6b880ca9bd3b9714ea">dtls_uint16_to_int</a>(data);
<a name="l00716"></a>00716   <span class="keywordflow">if</span> (data_length &lt; i + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>)) {
<a name="l00717"></a>00717     <span class="comment">/* Looks like we do not have a cipher nor compression. This is ok</span>
<a name="l00718"></a>00718 <span class="comment">     * for renegotiation, but not for the initial handshake. */</span>
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;cipher == <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>)
<a name="l00721"></a>00721       <span class="keywordflow">goto</span> error;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a21d9fac709d739535b0cbecce4c18830">cipher</a> = <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;cipher;
<a name="l00724"></a>00724     config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a5b009130dd024e424ae83cda739b9fa6">compression</a> = <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;compression;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordflow">return</span> 1;
<a name="l00727"></a>00727   }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   data += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00730"></a>00730   data_length -= <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>) + i;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732   ok = 0;
<a name="l00733"></a>00733   <span class="keywordflow">while</span> (i &amp;&amp; !ok) {
<a name="l00734"></a>00734     config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a21d9fac709d739535b0cbecce4c18830">cipher</a> = <a class="code" href="numeric_8h.html#a206397ac4e04dc6b880ca9bd3b9714ea">dtls_uint16_to_int</a>(data);
<a name="l00735"></a>00735     ok = <a class="code" href="dtls_8c.html#ac913eade769e02601effc0b588fa0693">known_cipher</a>(config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a21d9fac709d739535b0cbecce4c18830">cipher</a>);
<a name="l00736"></a>00736     i -= <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00737"></a>00737     data += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l00738"></a>00738   }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740   <span class="comment">/* skip remaining ciphers */</span>
<a name="l00741"></a>00741   data += i;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   <span class="keywordflow">if</span> (!ok) {
<a name="l00744"></a>00744     <span class="comment">/* reset config cipher to a well-defined value */</span>
<a name="l00745"></a>00745     config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a21d9fac709d739535b0cbecce4c18830">cipher</a> = <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>;
<a name="l00746"></a>00746     <span class="keywordflow">return</span> 0;
<a name="l00747"></a>00747   }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749   <span class="keywordflow">if</span> (data_length &lt; <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>)) { 
<a name="l00750"></a>00750     <span class="comment">/* no compression specified, take the current compression method */</span>
<a name="l00751"></a>00751     config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a5b009130dd024e424ae83cda739b9fa6">compression</a> = <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;compression;
<a name="l00752"></a>00752     <span class="keywordflow">return</span> 1;
<a name="l00753"></a>00753   }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755   i = <a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(data);
<a name="l00756"></a>00756   <span class="keywordflow">if</span> (data_length &lt; i + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>))
<a name="l00757"></a>00757     <span class="keywordflow">goto</span> error;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759   data += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00760"></a>00760   data_length -= <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>) + i;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762   ok = 0;
<a name="l00763"></a>00763   <span class="keywordflow">while</span> (i &amp;&amp; !ok) {
<a name="l00764"></a>00764     <span class="keywordflow">for</span> (j = 0; j &lt; <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#ae35671d94ccea5f335546ce409aed601">compression_methods</a>) / <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>); ++j)
<a name="l00765"></a>00765       <span class="keywordflow">if</span> (<a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(data) == <a class="code" href="dtls_8c.html#ae35671d94ccea5f335546ce409aed601">compression_methods</a>[j]) {
<a name="l00766"></a>00766     config-&gt;<a class="code" href="structdtls__security__parameters__t.html#a5b009130dd024e424ae83cda739b9fa6">compression</a> = <a class="code" href="dtls_8c.html#ae35671d94ccea5f335546ce409aed601">compression_methods</a>[j];
<a name="l00767"></a>00767     ok = 1;
<a name="l00768"></a>00768       }
<a name="l00769"></a>00769     i -= <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l00770"></a>00770     data += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);    
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772   
<a name="l00773"></a>00773   <span class="keywordflow">return</span> ok;
<a name="l00774"></a>00774  error:
<a name="l00775"></a>00775   <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;ClientHello too short (%d bytes)\n&quot;</span>, data_length);
<a name="l00776"></a>00776   <span class="keywordflow">return</span> 0;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00780"></a><a class="code" href="dtls_8c.html#a1ca57775f168ceeb75dd1d4cb3bea82a">00780</a> <a class="code" href="dtls_8c.html#a1ca57775f168ceeb75dd1d4cb3bea82a">check_client_keyexchange</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00781"></a>00781              <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l00782"></a>00782              <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> length) {
<a name="l00783"></a>00783   <span class="keywordflow">return</span> length &gt;= <a class="code" href="dtls_8c.html#a6832aa690127f1de63ed04f902869fea">DTLS_CKX_LENGTH</a> &amp;&amp; data[0] == <a class="code" href="dtls_8h.html#a577885c74492a460729a451f33a894c4">DTLS_HT_CLIENT_KEY_EXCHANGE</a>;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00787"></a><a class="code" href="dtls_8c.html#ac236d1b48c77c19c7f683f17cfd9955d">00787</a> <a class="code" href="dtls_8c.html#ac236d1b48c77c19c7f683f17cfd9955d">check_ccs</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00788"></a>00788       <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l00789"></a>00789       <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *record, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(record)-&gt;content_type != <a class="code" href="dtls_8h.html#a3114c327a12e3850e97c4cf8a0cc5c9d">DTLS_CT_CHANGE_CIPHER_SPEC</a>
<a name="l00792"></a>00792       || data_length &lt; 1 || data[0] != 1)
<a name="l00793"></a>00793     <span class="keywordflow">return</span> 0;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795   <span class="comment">/* set crypto context for TLS_PSK_WITH_AES_128_CCM_8 */</span>
<a name="l00796"></a>00796   <span class="comment">/* client */</span>
<a name="l00797"></a>00797   <a class="code" href="crypto_8c.html#ac13b8a8dcef3a88e3e8891e29f28b142">dtls_cipher_free</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   assert(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher != <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>);
<a name="l00800"></a>00800   <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher = 
<a name="l00801"></a>00801     <a class="code" href="crypto_8c.html#acd9148cfb9ce6193629ec539d92ce2aa">dtls_cipher_new</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher,
<a name="l00802"></a>00802             <a class="code" href="crypto_8h.html#a6a0f72fd69e56203b009228bf6de2e86">dtls_kb_client_write_key</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l00803"></a>00803             <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l00804"></a>00804 
<a name="l00805"></a>00805   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher) {
<a name="l00806"></a>00806     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot create read cipher\n&quot;</span>);
<a name="l00807"></a>00807     <span class="keywordflow">return</span> 0;
<a name="l00808"></a>00808   }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810   <a class="code" href="crypto_8c.html#af56d5c99667573a81f057d80d58e88b4">dtls_cipher_set_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher,
<a name="l00811"></a>00811              <a class="code" href="crypto_8h.html#a101af9642b17c1c3bbc804fdf9793e29">dtls_kb_client_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l00812"></a>00812              <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l00813"></a>00813 
<a name="l00814"></a>00814   <span class="comment">/* server */</span>
<a name="l00815"></a>00815   <a class="code" href="crypto_8c.html#ac13b8a8dcef3a88e3e8891e29f28b142">dtls_cipher_free</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher);
<a name="l00816"></a>00816   
<a name="l00817"></a>00817   <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher = 
<a name="l00818"></a>00818     <a class="code" href="crypto_8c.html#acd9148cfb9ce6193629ec539d92ce2aa">dtls_cipher_new</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher,
<a name="l00819"></a>00819             <a class="code" href="crypto_8h.html#ab6a59d24d58d19406e1913c110b4fc59">dtls_kb_server_write_key</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l00820"></a>00820             <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l00821"></a>00821 
<a name="l00822"></a>00822   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher) {
<a name="l00823"></a>00823     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot create write cipher\n&quot;</span>);
<a name="l00824"></a>00824     <span class="keywordflow">return</span> 0;
<a name="l00825"></a>00825   }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827   <a class="code" href="crypto_8c.html#af56d5c99667573a81f057d80d58e88b4">dtls_cipher_set_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher,
<a name="l00828"></a>00828              <a class="code" href="crypto_8h.html#acdbb2c30f60673e98d973412fde5aed3">dtls_kb_server_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l00829"></a>00829              <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l00830"></a>00830 
<a name="l00831"></a>00831   <span class="keywordflow">return</span> 1;
<a name="l00832"></a>00832 }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">size_t</span> <a class="code" href="debug_8c.html#adf05a794730eda4e59d1dbb98897eb02">dsrv_print_addr</a>(<span class="keyword">const</span> session_t *, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *, <span class="keywordtype">size_t</span>);
<a name="l00836"></a>00836 <span class="preprocessor">#endif</span>
<a name="l00837"></a>00837 <span class="preprocessor"></span>
<a name="l00838"></a>00838 <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *
<a name="l00839"></a><a class="code" href="dtls_8c.html#a24a60717e58c8335b1324ba6ef90601a">00839</a> <a class="code" href="dtls_8c.html#a24a60717e58c8335b1324ba6ef90601a">dtls_new_peer</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l00840"></a>00840           <span class="keyword">const</span> session_t *session) {
<a name="l00841"></a>00841   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843   peer = <a class="code" href="dtls_8c.html#a89738cd2081b322562b9893c524fb0e1">dtls_malloc_peer</a>();
<a name="l00844"></a>00844   <span class="keywordflow">if</span> (peer) {
<a name="l00845"></a>00845     memset(peer, 0, <span class="keyword">sizeof</span>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a>));
<a name="l00846"></a>00846     memcpy(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, session, <span class="keyword">sizeof</span>(session_t));
<a name="l00847"></a>00847 
<a name="l00848"></a>00848 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00849"></a>00849 <span class="preprocessor"></span>    {
<a name="l00850"></a>00850       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> addrbuf[72];
<a name="l00851"></a>00851       <a class="code" href="debug_8c.html#adf05a794730eda4e59d1dbb98897eb02">dsrv_print_addr</a>(session, addrbuf, <span class="keyword">sizeof</span>(addrbuf));
<a name="l00852"></a>00852       printf(<span class="stringliteral">&quot;dtls_new_peer: %s\n&quot;</span>, addrbuf);
<a name="l00853"></a>00853       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)session, <span class="keyword">sizeof</span>(session_t));
<a name="l00854"></a>00854       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 <span class="preprocessor">#endif</span>
<a name="l00857"></a>00857 <span class="preprocessor"></span>    <span class="comment">/* initially allow the NULL cipher */</span>
<a name="l00858"></a>00858     <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;cipher = <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860     <span class="comment">/* initialize the handshake hash wrt. the hard-coded DTLS version */</span>
<a name="l00861"></a>00861     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLSv12: initialize HASH_SHA256\n&quot;</span>);
<a name="l00862"></a>00862     <span class="comment">/* TLS 1.2:  PRF(secret, label, seed) = P_&lt;hash&gt;(secret, label + seed) */</span>
<a name="l00863"></a>00863     <span class="comment">/* FIXME: we use the default SHA256 here, might need to support other </span>
<a name="l00864"></a>00864 <span class="comment">              hash functions as well */</span>
<a name="l00865"></a>00865     dtls_hash_init(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>);
<a name="l00866"></a>00866   }
<a name="l00867"></a>00867   
<a name="l00868"></a>00868   <span class="keywordflow">return</span> peer;
<a name="l00869"></a>00869 }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00872"></a><a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">00872</a> <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> length) {
<a name="l00873"></a>00873 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00874"></a>00874 <span class="preprocessor"></span>  printf(<span class="stringliteral">&quot;add MAC data: &quot;</span>);
<a name="l00875"></a>00875   <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(data, length);
<a name="l00876"></a>00876   printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00877"></a>00877 <span class="preprocessor">#endif</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span>  dtls_hash_update(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>, data, length);
<a name="l00879"></a>00879 }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span>
<a name="l00882"></a><a class="code" href="dtls_8c.html#adb41bf916dc34af5cd79003a9243b727">00882</a> <a class="code" href="dtls_8c.html#adb41bf916dc34af5cd79003a9243b727">finalize_hs_hash</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>) {
<a name="l00883"></a>00883   <span class="keywordflow">return</span> dtls_hash_finalize(buf, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>);
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00887"></a><a class="code" href="dtls_8c.html#a82181208ec1e9f42896f0606e0036c1d">00887</a> <a class="code" href="dtls_8c.html#a82181208ec1e9f42896f0606e0036c1d">clear_hs_hash</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l00888"></a>00888   assert(peer);
<a name="l00889"></a>00889   dtls_hash_init(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>);
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00904"></a>00904 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00905"></a><a class="code" href="dtls_8c.html#a476fab7695f3f424bd33263e36ceefeb">00905</a> <a class="code" href="dtls_8c.html#a476fab7695f3f424bd33263e36ceefeb">check_finished</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l00906"></a>00906            <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *record, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l00907"></a>00907   <span class="keywordtype">size_t</span> digest_length, label_size;
<a name="l00908"></a>00908   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *label;
<a name="l00909"></a>00909   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>[<a class="code" href="group__HMAC.html#ga3e84ddbef6bf0084252e16e6c547e332">DTLS_HMAC_MAX</a>];
<a name="l00910"></a>00910 
<a name="l00911"></a>00911   <span class="comment">/* Use a union here to ensure that sufficient stack space is</span>
<a name="l00912"></a>00912 <span class="comment">   * reserved. As statebuf and verify_data are not used at the same</span>
<a name="l00913"></a>00913 <span class="comment">   * time, we can re-use the storage safely.</span>
<a name="l00914"></a>00914 <span class="comment">   */</span>
<a name="l00915"></a>00915   <span class="keyword">union </span>{
<a name="l00916"></a>00916     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> statebuf[DTLS_HASH_CTX_SIZE];
<a name="l00917"></a>00917     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> verify_data[<a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>];
<a name="l00918"></a>00918   } b;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920   <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;check Finish message\n&quot;</span>);
<a name="l00921"></a>00921   <span class="keywordflow">if</span> (record[0] != <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a> || !<a class="code" href="dtls_8c.html#afb71c900a4079e4c28675a5e1e05e3ef">IS_FINISHED</a>(data, data_length)) {
<a name="l00922"></a>00922     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;failed\n&quot;</span>);
<a name="l00923"></a>00923     <span class="keywordflow">return</span> 0;
<a name="l00924"></a>00924   }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926   <span class="comment">/* temporarily store hash status for roll-back after finalize */</span>
<a name="l00927"></a>00927   memcpy(b.statebuf, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>, DTLS_HASH_CTX_SIZE);
<a name="l00928"></a>00928 
<a name="l00929"></a>00929   digest_length = <a class="code" href="dtls_8c.html#adb41bf916dc34af5cd79003a9243b727">finalize_hs_hash</a>(peer, buf);
<a name="l00930"></a>00930   <span class="comment">/* clear_hash(); */</span>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932   <span class="comment">/* restore hash status */</span>
<a name="l00933"></a>00933   memcpy(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>, b.statebuf, DTLS_HASH_CTX_SIZE);
<a name="l00934"></a>00934 
<a name="l00935"></a>00935   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;role == <a class="code" href="crypto_8h.html#ae30cd4bcffed73f79f17c09e5a1452c8a7c2a694fc87273c445ad661575b28255">DTLS_SERVER</a>) {
<a name="l00936"></a>00936     label = <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(server);
<a name="l00937"></a>00937     label_size = <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(server);
<a name="l00938"></a>00938   } <span class="keywordflow">else</span> { <span class="comment">/* client */</span>
<a name="l00939"></a>00939     label = <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(client);
<a name="l00940"></a>00940     label_size = <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(client);
<a name="l00941"></a>00941   }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   <a class="code" href="crypto_8c.html#a5e47576e502b5a6255f1b489a4915512">dtls_prf</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;master_secret, 
<a name="l00944"></a>00944        <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>,
<a name="l00945"></a>00945        label, label_size,
<a name="l00946"></a>00946        <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(finished), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(finished),
<a name="l00947"></a>00947        buf, digest_length,
<a name="l00948"></a>00948        b.verify_data, <span class="keyword">sizeof</span>(b.verify_data));
<a name="l00949"></a>00949   
<a name="l00950"></a>00950 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00951"></a>00951 <span class="preprocessor"></span>  printf(<span class="stringliteral">&quot;d:\t&quot;</span>); <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(data + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>, <span class="keyword">sizeof</span>(b.verify_data)); printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00952"></a>00952   printf(<span class="stringliteral">&quot;v:\t&quot;</span>); <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(b.verify_data, <span class="keyword">sizeof</span>(b.verify_data)); printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00953"></a>00953 <span class="preprocessor">#endif</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 
<a name="l00955"></a>00955     memcmp(data + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>, b.verify_data, <span class="keyword">sizeof</span>(b.verify_data)) == 0;
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00980"></a>00980 <span class="keywordtype">int</span>
<a name="l00981"></a><a class="code" href="dtls_8c.html#a3dfa15f20cc7ddae5d1140c4bf3eb6fa">00981</a> <a class="code" href="dtls_8c.html#a3dfa15f20cc7ddae5d1140c4bf3eb6fa">dtls_prepare_record</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l00982"></a>00982             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> type,
<a name="l00983"></a>00983             <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length,
<a name="l00984"></a>00984             <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *sendbuf, <span class="keywordtype">size_t</span> *rlen) {
<a name="l00985"></a>00985   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p;
<a name="l00986"></a>00986   <span class="keywordtype">int</span> res;
<a name="l00987"></a>00987   
<a name="l00988"></a>00988   <span class="comment">/* check the minimum that we need for packets that are not encrypted */</span>
<a name="l00989"></a>00989   <span class="keywordflow">if</span> (*rlen &lt; <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a> + data_length) {
<a name="l00990"></a>00990     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dtls_prepare_record: send buffer too small\n&quot;</span>);
<a name="l00991"></a>00991     <span class="keywordflow">return</span> -1;
<a name="l00992"></a>00992   }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994   p = <a class="code" href="dtls_8c.html#adf3dc70178c98b927d619776e34ad65e">dtls_set_record_header</a>(type, peer, sendbuf);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;cipher == <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>) {
<a name="l00997"></a>00997     <span class="comment">/* no cipher suite */</span>
<a name="l00998"></a>00998     memcpy(p, data, data_length);
<a name="l00999"></a>00999     res = data_length;
<a name="l01000"></a>01000   } <span class="keywordflow">else</span> { <span class="comment">/* TLS_PSK_WITH_AES_128_CCM_8 */</span>   
<a name="l01001"></a>01001     <a class="code" href="structdtls__cipher__context__t.html">dtls_cipher_context_t</a> *cipher_context;
<a name="l01002"></a>01002 
<a name="l01007"></a>01007 <span class="preprocessor">#define A_DATA_LEN 13</span>
<a name="l01008"></a>01008 <span class="preprocessor"></span><span class="preprocessor">#define A_DATA N</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> N[max(<a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>, <a class="code" href="dtls_8c.html#aee0f4f3d8541ea6ab9c204761cc6082e">A_DATA_LEN</a>)];
<a name="l01010"></a>01010     
<a name="l01011"></a>01011     <span class="keywordflow">if</span> (*rlen &lt; <span class="keyword">sizeof</span>(<a class="code" href="structdtls__record__header__t.html">dtls_record_header_t</a>) + data_length + 8) {
<a name="l01012"></a>01012       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;dtls_prepare_record(): send buffer too small\n&quot;</span>);
<a name="l01013"></a>01013       <span class="keywordflow">return</span> -1;
<a name="l01014"></a>01014     }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dtls_prepare_record(): encrypt using TLS_PSK_WITH_AES_128_CCM_8\n&quot;</span>);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     <span class="comment">/* set nonce       </span>
<a name="l01019"></a>01019 <span class="comment">       from http://tools.ietf.org/html/draft-mcgrew-tls-aes-ccm-03:</span>
<a name="l01020"></a>01020 <span class="comment">        struct {</span>
<a name="l01021"></a>01021 <span class="comment">               case client:</span>
<a name="l01022"></a>01022 <span class="comment">                  uint32 client_write_IV;  // low order 32-bits</span>
<a name="l01023"></a>01023 <span class="comment">               case server:</span>
<a name="l01024"></a>01024 <span class="comment">                  uint32 server_write_IV;  // low order 32-bits</span>
<a name="l01025"></a>01025 <span class="comment">               uint64 seq_num;</span>
<a name="l01026"></a>01026 <span class="comment">            } CCMNonce.</span>
<a name="l01027"></a>01027 <span class="comment"></span>
<a name="l01028"></a>01028 <span class="comment">        In DTLS, the 64-bit seq_num is the 16-bit epoch concatenated with the</span>
<a name="l01029"></a>01029 <span class="comment">        48-bit seq_num.</span>
<a name="l01030"></a>01030 <span class="comment">    */</span>
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     memcpy(p, &amp;<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(sendbuf)-&gt;epoch, 8);
<a name="l01033"></a>01033     memcpy(p + 8, data, data_length);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     memset(N, 0, <a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>);
<a name="l01036"></a>01036     memcpy(N, <a class="code" href="crypto_8h.html#a3660536f2b8583439cc9a63f812ea843">dtls_kb_local_iv</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01037"></a>01037        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01038"></a>01038     memcpy(N + <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), p, 8); <span class="comment">/* epoch + seq_num */</span>
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     cipher_context = <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;write_cipher;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (!cipher_context) {
<a name="l01043"></a>01043       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;no write_cipher available!\n&quot;</span>);
<a name="l01044"></a>01044       <span class="keywordflow">return</span> -1;
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;nonce:\t&quot;</span>);
<a name="l01048"></a>01048     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(N, <a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>);
<a name="l01049"></a>01049     printf(<span class="stringliteral">&quot;\nkey:\t&quot;</span>);
<a name="l01050"></a>01050     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a07e5630bda444342e1622adad5660270">dtls_kb_local_write_key</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01051"></a>01051      <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01052"></a>01052     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01053"></a>01053 <span class="preprocessor">#endif</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span>    <a class="code" href="crypto_8c.html#af56d5c99667573a81f057d80d58e88b4">dtls_cipher_set_iv</a>(cipher_context, N, <a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>);
<a name="l01055"></a>01055     
<a name="l01056"></a>01056     <span class="comment">/* re-use N to create additional data according to RFC 5246, Section 6.2.3.3:</span>
<a name="l01057"></a>01057 <span class="comment">     * </span>
<a name="l01058"></a>01058 <span class="comment">     * additional_data = seq_num + TLSCompressed.type +</span>
<a name="l01059"></a>01059 <span class="comment">     *                   TLSCompressed.version + TLSCompressed.length;</span>
<a name="l01060"></a>01060 <span class="comment">     */</span>
<a name="l01061"></a>01061     memcpy(<a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a>, &amp;<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(sendbuf)-&gt;epoch, 8); <span class="comment">/* epoch and seq_num */</span>
<a name="l01062"></a>01062     memcpy(<a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a> + 8,  &amp;<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(sendbuf)-&gt;content_type, 3); <span class="comment">/* type and version */</span>
<a name="l01063"></a>01063     <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(<a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a> + 11, data_length); <span class="comment">/* length */</span>
<a name="l01064"></a>01064     
<a name="l01065"></a>01065     res = <a class="code" href="crypto_8c.html#a95f39cd38babdcd4cec7815be02cbe39">dtls_encrypt</a>(cipher_context, p + 8, data_length, p + 8,
<a name="l01066"></a>01066                <a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a>, <a class="code" href="dtls_8c.html#aee0f4f3d8541ea6ab9c204761cc6082e">A_DATA_LEN</a>);
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01069"></a>01069       <span class="keywordflow">return</span> -1;
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span>    <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(p, res + 8);
<a name="l01073"></a>01073     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01074"></a>01074 <span class="preprocessor">#endif</span>
<a name="l01075"></a>01075 <span class="preprocessor"></span>    res += 8;           <span class="comment">/* increment res by size of nonce_explicit */</span>
<a name="l01076"></a>01076   }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078   <span class="comment">/* fix length of fragment in sendbuf */</span>
<a name="l01079"></a>01079   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(sendbuf + 11, res);
<a name="l01080"></a>01080   
<a name="l01081"></a>01081   *rlen = <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a> + res;
<a name="l01082"></a>01082   <span class="keywordflow">return</span> 1;
<a name="l01083"></a>01083 }
<a name="l01084"></a>01084 
<a name="l01099"></a><a class="code" href="dtls_8c.html#a9279d8f0e7c7b30f968ed085b5a3136f">01099</a> <span class="preprocessor">#define MUST_HASH(Type, Data, Length)                   \</span>
<a name="l01100"></a>01100 <span class="preprocessor">  ((Type) == DTLS_CT_HANDSHAKE &amp;&amp;                   \</span>
<a name="l01101"></a>01101 <span class="preprocessor">   ((Data) != NULL) &amp;&amp; ((Length) &gt; 0)  &amp;&amp;               \</span>
<a name="l01102"></a>01102 <span class="preprocessor">   ((Data)[0] != DTLS_HT_HELLO_VERIFY_REQUEST) &amp;&amp;           \</span>
<a name="l01103"></a>01103 <span class="preprocessor">   ((Data)[0] != DTLS_HT_CLIENT_HELLO ||                \</span>
<a name="l01104"></a>01104 <span class="preprocessor">    ((Length) &gt;= HS_HDR_LENGTH &amp;&amp;                   \</span>
<a name="l01105"></a>01105 <span class="preprocessor">     (dtls_uint16_to_int(DTLS_RECORD_HEADER(Data)-&gt;epoch &gt; 0) ||    \</span>
<a name="l01106"></a>01106 <span class="preprocessor">      (dtls_uint16_to_int(HANDSHAKE(Data)-&gt;message_seq) &gt; 0)))))</span>
<a name="l01107"></a>01107 <span class="preprocessor"></span>
<a name="l01121"></a>01121 <span class="keywordtype">int</span>
<a name="l01122"></a><a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">01122</a> <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l01123"></a>01123       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> type,
<a name="l01124"></a>01124       <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="dtls-client_8c.html#ad6994903b3c19997ffcfdccb4431d308">buflen</a>) {
<a name="l01125"></a>01125   
<a name="l01126"></a>01126   <span class="comment">/* We cannot use ctx-&gt;sendbuf here as it is reserved for collecting</span>
<a name="l01127"></a>01127 <span class="comment">   * the input for this function, i.e. buf == ctx-&gt;sendbuf.</span>
<a name="l01128"></a>01128 <span class="comment">   *</span>
<a name="l01129"></a>01129 <span class="comment">   * TODO: check if we can use the receive buf here. This would mean</span>
<a name="l01130"></a>01130 <span class="comment">   * that we might not be able to handle multiple records stuffed in</span>
<a name="l01131"></a>01131 <span class="comment">   * one UDP datagram */</span>
<a name="l01132"></a>01132   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sendbuf[DTLS_MAX_BUF];
<a name="l01133"></a>01133   <span class="keywordtype">size_t</span> len = <span class="keyword">sizeof</span>(sendbuf);
<a name="l01134"></a>01134   <span class="keywordtype">int</span> res;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136   res = <a class="code" href="dtls_8c.html#a3dfa15f20cc7ddae5d1140c4bf3eb6fa">dtls_prepare_record</a>(peer, type, buf, buflen, sendbuf, &amp;len);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138   <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01139"></a>01139     <span class="keywordflow">return</span> res;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141   <span class="comment">/* if (peer &amp;&amp; MUST_HASH(peer, type, buf, buflen)) */</span>
<a name="l01142"></a>01142   <span class="comment">/*   update_hs_hash(peer, buf, buflen); */</span>
<a name="l01143"></a>01143   
<a name="l01144"></a>01144 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01145"></a>01145 <span class="preprocessor"></span>  <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;send %d bytes\n&quot;</span>, buflen);
<a name="l01146"></a>01146   <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(sendbuf, <span class="keyword">sizeof</span>(<a class="code" href="structdtls__record__header__t.html">dtls_record_header_t</a>));
<a name="l01147"></a>01147   printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01148"></a>01148   <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(buf, buflen);
<a name="l01149"></a>01149   printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01150"></a>01150 <span class="preprocessor">#endif</span>
<a name="l01151"></a>01151 <span class="preprocessor"></span>
<a name="l01152"></a>01152   <span class="keywordflow">if</span> (type == <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a> &amp;&amp; buf[0] != <a class="code" href="dtls_8h.html#ab04f98f1863c785fabd97925c9746f7d">DTLS_HT_HELLO_VERIFY_REQUEST</a>) {
<a name="l01153"></a>01153     <span class="comment">/* copy handshake messages other than HelloVerify into retransmit buffer */</span>
<a name="l01154"></a>01154     <a class="code" href="structnetq__t.html">netq_t</a> *n = <a class="code" href="group__netq.html#ga655b15452b839a4b2bda97ce7c7323ef">netq_node_new</a>();
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (n) {
<a name="l01156"></a>01156       n-&gt;<a class="code" href="structnetq__t.html#afe91256ff5267fc680b96efd3bd8635a">t</a> = <a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">clock_time</a>() + 2 * <a class="code" href="dtls_8c.html#ae3ced0551b26c9b99cb45a86f34d100a">CLOCK_SECOND</a>;
<a name="l01157"></a>01157       n-&gt;<a class="code" href="structnetq__t.html#aacd03017f40248c2f48c2b7b9cd92dc8">retransmit_cnt</a> = 0;
<a name="l01158"></a>01158       n-&gt;<a class="code" href="structnetq__t.html#ae0c2648acf87d1e6f2566bc3600771b6">timeout</a> = 2 * <a class="code" href="dtls_8c.html#ae3ced0551b26c9b99cb45a86f34d100a">CLOCK_SECOND</a>;
<a name="l01159"></a>01159       n-&gt;<a class="code" href="structnetq__t.html#aaca5f6407bd7b3162d9ee7e7e7b8f0ff">peer</a> = peer;
<a name="l01160"></a>01160       n-&gt;<a class="code" href="structnetq__t.html#ac72c9378282becab5a273f612f58c124">length</a> = <a class="code" href="dtls-client_8c.html#ad6994903b3c19997ffcfdccb4431d308">buflen</a>;
<a name="l01161"></a>01161       memcpy(n-&gt;<a class="code" href="structnetq__t.html#a13f460c7491e57bc97abcf87953e4ab9">data</a>, buf, buflen);
<a name="l01162"></a>01162 
<a name="l01163"></a>01163       <span class="keywordflow">if</span> (!<a class="code" href="group__netq.html#ga8045aa49152a3c97c65ef6dbb03e1295">netq_insert_node</a>((<a class="code" href="structnetq__t.html">netq_t</a> **)ctx-&gt;sendqueue, n)) {
<a name="l01164"></a>01164     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot add packet to retransmit buffer\n&quot;</span>);
<a name="l01165"></a>01165     <a class="code" href="group__netq.html#ga9ef9da1a2af266dadef83ddf6c8524d7">netq_node_free</a>(n);
<a name="l01166"></a>01166 <span class="preprocessor">#ifdef WITH_CONTIKI</span>
<a name="l01167"></a>01167 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> {
<a name="l01168"></a>01168     <span class="comment">/* must set timer within the context of the retransmit process */</span>
<a name="l01169"></a>01169     PROCESS_CONTEXT_BEGIN(&amp;dtls_retransmit_process);
<a name="l01170"></a>01170     etimer_set(&amp;ctx-&gt;retransmit_timer, n-&gt;<a class="code" href="structnetq__t.html#ae0c2648acf87d1e6f2566bc3600771b6">timeout</a>);
<a name="l01171"></a>01171     PROCESS_CONTEXT_END(&amp;dtls_retransmit_process);
<a name="l01172"></a>01172 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l01173"></a>01173       }
<a name="l01174"></a>01174     } <span class="keywordflow">else</span> 
<a name="l01175"></a>01175       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;retransmit buffer full\n&quot;</span>);
<a name="l01176"></a>01176   }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   <span class="comment">/* FIXME: copy to peer&#39;s sendqueue (after fragmentation if</span>
<a name="l01179"></a>01179 <span class="comment">   * necessary) and initialize retransmit timer */</span>
<a name="l01180"></a>01180   res = <a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, write, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, sendbuf, len);
<a name="l01181"></a>01181 
<a name="l01182"></a>01182   <span class="comment">/* Guess number of bytes application data actually sent:</span>
<a name="l01183"></a>01183 <span class="comment">   * dtls_prepare_record() tells us in len the number of bytes to</span>
<a name="l01184"></a>01184 <span class="comment">   * send, res will contain the bytes actually sent. */</span>
<a name="l01185"></a>01185   <span class="keywordflow">return</span> res &lt;= 0 ? res : buflen - (len - res);
<a name="l01186"></a>01186 }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01189"></a><a class="code" href="dtls_8c.html#a1829e5474862cb944e9f9975ff6bd9bf">01189</a> <a class="code" href="dtls_8c.html#a1829e5474862cb944e9f9975ff6bd9bf">dtls_alert</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, <a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871f">dtls_alert_level_t</a> level,
<a name="l01190"></a>01190        <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbd">dtls_alert_t</a> description) {
<a name="l01191"></a>01191   uint8_t msg[] = { level, description };
<a name="l01192"></a>01192 
<a name="l01193"></a>01193   <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#af8ce2230240b6d3c36b216ef459baff1">DTLS_CT_ALERT</a>, msg, <span class="keyword">sizeof</span>(msg));
<a name="l01194"></a>01194   <span class="keywordflow">return</span> 0;
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 <span class="keywordtype">int</span> 
<a name="l01198"></a><a class="code" href="dtls_8h.html#aa90f5eb6954137d5e098e29143c2586a">01198</a> <a class="code" href="dtls_8c.html#aa90f5eb6954137d5e098e29143c2586a">dtls_close</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <span class="keyword">const</span> session_t *remote) {
<a name="l01199"></a>01199   <span class="keywordtype">int</span> res = -1;
<a name="l01200"></a>01200   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202   peer = <a class="code" href="dtls_8c.html#a4cd69a01bbd9a73ebb2502e2e46d1bba">dtls_get_peer</a>(ctx, remote);
<a name="l01203"></a>01203 
<a name="l01204"></a>01204   <span class="keywordflow">if</span> (peer) {
<a name="l01205"></a>01205     res = <a class="code" href="dtls_8c.html#a1829e5474862cb944e9f9975ff6bd9bf">dtls_alert</a>(ctx, peer, <a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871fabd07bcf63c24aa5f1b9706a4197ceaf4">DTLS_ALERT_LEVEL_FATAL</a>, <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbdaed5c5f79854fde6049bfa46955f166b0">DTLS_ALERT_CLOSE</a>);
<a name="l01206"></a>01206     <span class="comment">/* indicate tear down */</span>
<a name="l01207"></a>01207     peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a4aa3fcce37191fc2a915aa330efd381b">DTLS_STATE_CLOSING</a>;
<a name="l01208"></a>01208   }
<a name="l01209"></a>01209   <span class="keywordflow">return</span> res;
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 <span class="keywordtype">int</span>
<a name="l01213"></a><a class="code" href="dtls_8c.html#ad629df3066c0352a4053c95a92b46d49">01213</a> <a class="code" href="dtls_8c.html#ad629df3066c0352a4053c95a92b46d49">dtls_send_server_hello</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l01214"></a>01214 
<a name="l01215"></a>01215   <span class="keyword">static</span> <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>[DTLS_MAX_BUF];
<a name="l01216"></a>01216   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p = <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>, *q = ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>;
<a name="l01217"></a>01217   <span class="keywordtype">size_t</span> qlen = <span class="keyword">sizeof</span>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01218"></a>01218   <span class="keywordtype">int</span> res;
<a name="l01219"></a>01219   <span class="keyword">const</span> <a class="code" href="structdtls__key__t.html">dtls_key_t</a> *key;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221   <span class="comment">/* Ensure that the largest message to create fits in our source</span>
<a name="l01222"></a>01222 <span class="comment">   * buffer. (The size of the destination buffer is checked by the</span>
<a name="l01223"></a>01223 <span class="comment">   * encoding function, so we do not need to guess.) */</span>
<a name="l01224"></a>01224   assert(<span class="keyword">sizeof</span>(buf) &gt;=
<a name="l01225"></a>01225      <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a> + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#afcca5dc5ebcc9eb8141ca0b49b647676">DTLS_SH_LENGTH</a> + 20);
<a name="l01226"></a>01226 
<a name="l01227"></a>01227   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, <a class="code" href="dtls-client_8c.html#a37d42859ab4946b1c20525e09f8e9272">get_key</a>, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, NULL, 0, &amp;key) &lt; 0) {
<a name="l01228"></a>01228     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dtls_send_server_hello(): no key for session available\n&quot;</span>);
<a name="l01229"></a>01229     <span class="keywordflow">return</span> -1;
<a name="l01230"></a>01230   }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232   <span class="comment">/* Handshake header */</span>
<a name="l01233"></a>01233   p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#ad5882a5ff4073ffefa266bb2c4a1ee3c">DTLS_HT_SERVER_HELLO</a>, 
<a name="l01234"></a>01234                 peer,
<a name="l01235"></a>01235                 <a class="code" href="dtls_8c.html#afcca5dc5ebcc9eb8141ca0b49b647676">DTLS_SH_LENGTH</a>, 
<a name="l01236"></a>01236                 0, <a class="code" href="dtls_8c.html#afcca5dc5ebcc9eb8141ca0b49b647676">DTLS_SH_LENGTH</a>,
<a name="l01237"></a>01237                 buf);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239   <span class="comment">/* ServerHello */</span>
<a name="l01240"></a>01240   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>);
<a name="l01241"></a>01241   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01242"></a>01242 
<a name="l01243"></a>01243   <span class="comment">/* Set server random: First generate 28 bytes of random data and then </span>
<a name="l01244"></a>01244 <span class="comment">   * overwrite the leading 4 bytes with the timestamp. */</span>
<a name="l01245"></a>01245   prng(p, 28);
<a name="l01246"></a>01246   <a class="code" href="numeric_8h.html#a5508498c45a0259b2c02f9bf950fa090">dtls_int_to_uint32</a>(p + 28, <a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">clock_time</a>());
<a name="l01247"></a>01247 
<a name="l01248"></a>01248   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#a114248a98717ac20854472dcfd45ea16">calculate_key_block</a>(ctx, <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer), key, 
<a name="l01249"></a>01249                <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random, p))
<a name="l01250"></a>01250     <span class="keywordflow">return</span> -1;
<a name="l01251"></a>01251 
<a name="l01252"></a>01252   p += 32;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254   *p++ = 0;         <span class="comment">/* no session id */</span>
<a name="l01255"></a>01255 
<a name="l01256"></a>01256   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher != <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>) {
<a name="l01257"></a>01257     <span class="comment">/* selected cipher suite */</span>
<a name="l01258"></a>01258     <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher);
<a name="l01259"></a>01259     p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01260"></a>01260 
<a name="l01261"></a>01261     <span class="comment">/* selected compression method */</span>
<a name="l01262"></a>01262     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;compression &gt;= 0)
<a name="l01263"></a>01263       *p++ = <a class="code" href="dtls_8c.html#ae35671d94ccea5f335546ce409aed601">compression_methods</a>[<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;compression];
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     <span class="comment">/* FIXME: if key-&gt;psk.id != NULL we need the server key exchange */</span>
<a name="l01266"></a>01266 
<a name="l01267"></a>01267     <span class="comment">/* update the finish hash </span>
<a name="l01268"></a>01268 <span class="comment">       (FIXME: better put this in generic record_send function) */</span>
<a name="l01269"></a>01269     <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, buf, p - buf);
<a name="l01270"></a>01270   }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272   res = <a class="code" href="dtls_8c.html#a3dfa15f20cc7ddae5d1140c4bf3eb6fa">dtls_prepare_record</a>(peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l01273"></a>01273                 buf, p - buf,
<a name="l01274"></a>01274                 q, &amp;qlen);
<a name="l01275"></a>01275   <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01276"></a>01276     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dtls_server_hello: cannot prepare ServerHello record\n&quot;</span>);
<a name="l01277"></a>01277     <span class="keywordflow">return</span> res;
<a name="l01278"></a>01278   }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280   q += qlen;
<a name="l01281"></a>01281   qlen = <span class="keyword">sizeof</span>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>) - qlen;
<a name="l01282"></a>01282 
<a name="l01283"></a>01283   <span class="comment">/* ServerHelloDone </span>
<a name="l01284"></a>01284 <span class="comment">   *</span>
<a name="l01285"></a>01285 <span class="comment">   * Start message construction at beginning of buffer. */</span>
<a name="l01286"></a>01286   p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#a44399f223a3e1c8a8bf3fc638a06a4d7">DTLS_HT_SERVER_HELLO_DONE</a>, 
<a name="l01287"></a>01287                 peer,
<a name="l01288"></a>01288                 0, <span class="comment">/* ServerHelloDone has no extra fields */</span>
<a name="l01289"></a>01289                 0, 0, <span class="comment">/* ServerHelloDone has no extra fields */</span>
<a name="l01290"></a>01290                 buf);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292   <span class="comment">/* update the finish hash </span>
<a name="l01293"></a>01293 <span class="comment">     (FIXME: better put this in generic record_send function) */</span>
<a name="l01294"></a>01294   <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, buf, p - buf);
<a name="l01295"></a>01295 
<a name="l01296"></a>01296   res = <a class="code" href="dtls_8c.html#a3dfa15f20cc7ddae5d1140c4bf3eb6fa">dtls_prepare_record</a>(peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l01297"></a>01297                 buf, p - buf,
<a name="l01298"></a>01298                 q, &amp;qlen);
<a name="l01299"></a>01299   <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01300"></a>01300     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dtls_server_hello: cannot prepare ServerHelloDone record\n&quot;</span>);
<a name="l01301"></a>01301     <span class="keywordflow">return</span> res;
<a name="l01302"></a>01302   }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304   <span class="keywordflow">return</span> <a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, write, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>,  
<a name="l01305"></a>01305           ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, (q + qlen) - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01306"></a>01306 }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> 
<a name="l01309"></a><a class="code" href="dtls_8c.html#a9cfb3c9e63f378d0d8e3d3d0c60537a5">01309</a> <a class="code" href="dtls_8c.html#a9cfb3c9e63f378d0d8e3d3d0c60537a5">dtls_send_ccs</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l01310"></a>01310   ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>[0] = 1;
<a name="l01311"></a>01311   <span class="keywordflow">return</span> <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a3114c327a12e3850e97c4cf8a0cc5c9d">DTLS_CT_CHANGE_CIPHER_SPEC</a>, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, 1);
<a name="l01312"></a>01312 }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     
<a name="l01315"></a>01315 <span class="keywordtype">int</span> 
<a name="l01316"></a><a class="code" href="dtls_8c.html#a6723acf40fd93665a916e35c20577d6e">01316</a> <a class="code" href="dtls_8c.html#a6723acf40fd93665a916e35c20577d6e">dtls_send_kx</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, <span class="keywordtype">int</span> is_client) {
<a name="l01317"></a>01317   <span class="keyword">const</span> <a class="code" href="structdtls__key__t.html">dtls_key_t</a> *key;
<a name="l01318"></a>01318   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p = ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>;
<a name="l01319"></a>01319   <span class="keywordtype">size_t</span> size;
<a name="l01320"></a>01320   <span class="keywordtype">int</span> ht = is_client 
<a name="l01321"></a>01321     ? <a class="code" href="dtls_8h.html#a577885c74492a460729a451f33a894c4">DTLS_HT_CLIENT_KEY_EXCHANGE</a> 
<a name="l01322"></a>01322     : <a class="code" href="dtls_8h.html#aab327e17614cf2902c5fc6169466613f">DTLS_HT_SERVER_KEY_EXCHANGE</a>;
<a name="l01323"></a>01323   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = NULL;
<a name="l01324"></a>01324   <span class="keywordtype">size_t</span> id_len = 0;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, <a class="code" href="dtls-client_8c.html#a37d42859ab4946b1c20525e09f8e9272">get_key</a>, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, NULL, 0, &amp;key) &lt; 0) {
<a name="l01327"></a>01327     <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da3537fbf756308b6267dd4354615eb413">LOG_CRIT</a>, <span class="stringliteral">&quot;no key to send in kx\n&quot;</span>);
<a name="l01328"></a>01328     <span class="keywordflow">return</span> -2;
<a name="l01329"></a>01329   }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331   assert(key);
<a name="l01332"></a>01332 
<a name="l01333"></a>01333   <span class="keywordflow">switch</span> (key-&gt;<a class="code" href="structdtls__key__t.html#a15298324dc6d5cb15a412d0fff3f99a2">type</a>) {
<a name="l01334"></a>01334   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#a32d8ede1d6b5ee6eb1fc32e101743ab9a6a96b075c28b3c167a1a238a33103e17">DTLS_KEY_PSK</a>: {
<a name="l01335"></a>01335     id_len = key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.id_length;
<a name="l01336"></a>01336     <span class="keywordtype">id</span> = key-&gt;<a class="code" href="structdtls__key__t.html#a9fc9e6e9c647ecbdbb80ebad1ec41604">key</a>.psk.id;
<a name="l01337"></a>01337     <span class="keywordflow">break</span>;
<a name="l01338"></a>01338   }
<a name="l01339"></a>01339   <span class="keywordflow">default</span>:
<a name="l01340"></a>01340     <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da3537fbf756308b6267dd4354615eb413">LOG_CRIT</a>, <span class="stringliteral">&quot;key type not supported\n&quot;</span>);
<a name="l01341"></a>01341     <span class="keywordflow">return</span> -3;
<a name="l01342"></a>01342   }
<a name="l01343"></a>01343   
<a name="l01344"></a>01344   size = id_len + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01345"></a>01345   p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(ht, peer, size, 0, size, p);
<a name="l01346"></a>01346 
<a name="l01347"></a>01347   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, id_len);
<a name="l01348"></a>01348   memcpy(p + <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>), <span class="keywordtype">id</span>, id_len);
<a name="l01349"></a>01349 
<a name="l01350"></a>01350   p += size;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352   <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01353"></a>01353   <span class="keywordflow">return</span> <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l01354"></a>01354            ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a><a class="code" href="dtls_8c.html#a727657c75e4ffea82e86e905e4640c25">01357</a> <span class="preprocessor">#define msg_overhead(Peer,Length) (DTLS_RH_LENGTH + \</span>
<a name="l01358"></a>01358 <span class="preprocessor">  ((Length + dtls_kb_iv_size(CURRENT_CONFIG(Peer)) + \</span>
<a name="l01359"></a>01359 <span class="preprocessor">    dtls_kb_digest_size(CURRENT_CONFIG(Peer))) /     \</span>
<a name="l01360"></a>01360 <span class="preprocessor">   DTLS_BLK_LENGTH + 1) * DTLS_BLK_LENGTH)</span>
<a name="l01361"></a>01361 <span class="preprocessor"></span>
<a name="l01362"></a>01362 <span class="keywordtype">int</span>
<a name="l01363"></a><a class="code" href="dtls_8c.html#a47c13c41aeab184fdc1ee36b30121262">01363</a> <a class="code" href="dtls_8c.html#a47c13c41aeab184fdc1ee36b30121262">dtls_send_server_finished</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l01364"></a>01364 
<a name="l01365"></a>01365   <span class="keywordtype">int</span> length;
<a name="l01366"></a>01366   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>[<a class="code" href="group__HMAC.html#ga3e84ddbef6bf0084252e16e6c547e332">DTLS_HMAC_MAX</a>];
<a name="l01367"></a>01367   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p = ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369   <span class="comment">/* FIXME: adjust message overhead calculation */</span>
<a name="l01370"></a>01370   assert(<a class="code" href="dtls_8c.html#a727657c75e4ffea82e86e905e4640c25">msg_overhead</a>(peer, <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>) 
<a name="l01371"></a>01371      &lt; <span class="keyword">sizeof</span>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>));
<a name="l01372"></a>01372 
<a name="l01373"></a>01373   p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#a16b49d03e041d43b60e1b7bacf35daad">DTLS_HT_FINISHED</a>, 
<a name="l01374"></a>01374                                 peer, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>, 0, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>, p);
<a name="l01375"></a>01375   
<a name="l01376"></a>01376   length = <a class="code" href="dtls_8c.html#adb41bf916dc34af5cd79003a9243b727">finalize_hs_hash</a>(peer, buf);
<a name="l01377"></a>01377 
<a name="l01378"></a>01378   <a class="code" href="crypto_8c.html#a5e47576e502b5a6255f1b489a4915512">dtls_prf</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;master_secret, 
<a name="l01379"></a>01379        <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>,
<a name="l01380"></a>01380        <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(server), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(server), 
<a name="l01381"></a>01381        <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(finished), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(finished), 
<a name="l01382"></a>01382        buf, length,
<a name="l01383"></a>01383        p, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01386"></a>01386 <span class="preprocessor"></span>  printf(<span class="stringliteral">&quot;server finished MAC:\t&quot;</span>);
<a name="l01387"></a>01387   <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(p, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>);
<a name="l01388"></a>01388   printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01389"></a>01389 <span class="preprocessor">#endif</span>
<a name="l01390"></a>01390 <span class="preprocessor"></span>
<a name="l01391"></a>01391   p += <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393   <span class="keywordflow">return</span> <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l01394"></a>01394            ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01395"></a>01395 }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01398"></a><a class="code" href="dtls_8c.html#afcc64c0abfd9b157b71a47e5a5a78b26">01398</a> <a class="code" href="dtls_8c.html#afcc64c0abfd9b157b71a47e5a5a78b26">check_server_hello</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l01399"></a>01399               <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l01400"></a>01400               <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l01401"></a>01401   <a class="code" href="structdtls__hello__verify__t.html">dtls_hello_verify_t</a> *hv;
<a name="l01402"></a>01402   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p = ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>;
<a name="l01403"></a>01403   <span class="keywordtype">size_t</span> size;
<a name="l01404"></a>01404   <span class="keywordtype">int</span> res;
<a name="l01405"></a>01405   <span class="keyword">const</span> <a class="code" href="structdtls__key__t.html">dtls_key_t</a> *key;
<a name="l01406"></a>01406 
<a name="l01407"></a>01407   <span class="comment">/* This function is called when we expect a ServerHello (i.e. we</span>
<a name="l01408"></a>01408 <span class="comment">   * have sent a ClientHello).  We might instead receive a HelloVerify</span>
<a name="l01409"></a>01409 <span class="comment">   * request containing a cookie. If so, we must repeat the</span>
<a name="l01410"></a>01410 <span class="comment">   * ClientHello with the given Cookie.</span>
<a name="l01411"></a>01411 <span class="comment">   */</span>
<a name="l01412"></a>01412 
<a name="l01413"></a>01413   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#aee5c7389d414d6232602a073b826bdd8">IS_SERVERHELLO</a>(data, data_length)) {
<a name="l01414"></a>01414     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;handle ServerHello\n&quot;</span>);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416     <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, data, data_length);
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     <span class="comment">/* FIXME: check data_length before accessing fields */</span>
<a name="l01419"></a>01419 
<a name="l01420"></a>01420     <span class="comment">/* Get the server&#39;s random data and store selected cipher suite</span>
<a name="l01421"></a>01421 <span class="comment">     * and compression method (like dtls_update_parameters().</span>
<a name="l01422"></a>01422 <span class="comment">     * Then calculate master secret and wait for ServerHelloDone. When received,</span>
<a name="l01423"></a>01423 <span class="comment">     * send ClientKeyExchange (?) and ChangeCipherSpec + ClientFinished. */</span>
<a name="l01424"></a>01424     
<a name="l01425"></a>01425     <span class="comment">/* check server version */</span>
<a name="l01426"></a>01426     data += <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>;
<a name="l01427"></a>01427     data_length -= <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>;
<a name="l01428"></a>01428     
<a name="l01429"></a>01429     <span class="keywordflow">if</span> (<a class="code" href="numeric_8h.html#a206397ac4e04dc6b880ca9bd3b9714ea">dtls_uint16_to_int</a>(data) != <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>) {
<a name="l01430"></a>01430       <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;unknown DTLS version\n&quot;</span>);
<a name="l01431"></a>01431       <span class="keywordflow">goto</span> error;
<a name="l01432"></a>01432     }
<a name="l01433"></a>01433 
<a name="l01434"></a>01434     data += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);       <span class="comment">/* skip version field */</span>
<a name="l01435"></a>01435     data_length -= <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437     <span class="comment">/* FIXME: check PSK hint */</span>
<a name="l01438"></a>01438     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, <a class="code" href="dtls-client_8c.html#a37d42859ab4946b1c20525e09f8e9272">get_key</a>, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, NULL, 0, &amp;key) &lt; 0
<a name="l01439"></a>01439     || !<a class="code" href="dtls_8c.html#a114248a98717ac20854472dcfd45ea16">calculate_key_block</a>(ctx, <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer), key, 
<a name="l01440"></a>01440                 <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random, data)) {
<a name="l01441"></a>01441       <span class="keywordflow">goto</span> error;
<a name="l01442"></a>01442     }
<a name="l01443"></a>01443     <span class="comment">/* store server random data */</span>
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     <span class="comment">/* memcpy(OTHER_CONFIG(peer)-&gt;server_random, data, */</span>
<a name="l01446"></a>01446     <span class="comment">/*     sizeof(OTHER_CONFIG(peer)-&gt;server_random)); */</span>
<a name="l01447"></a>01447     data += <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random);
<a name="l01448"></a>01448     data_length -= <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random);
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     <a class="code" href="dtls_8c.html#a09a0896d586ff27855ced6930cc17023">SKIP_VAR_FIELD</a>(data, data_length, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>); <span class="comment">/* skip session id */</span>
<a name="l01451"></a>01451     
<a name="l01452"></a>01452     <span class="comment">/* Check cipher suite. As we offer all we have, it is sufficient</span>
<a name="l01453"></a>01453 <span class="comment">     * to check if the cipher suite selected by the server is in our</span>
<a name="l01454"></a>01454 <span class="comment">     * list of known cipher suites. Subsets are not supported. */</span>
<a name="l01455"></a>01455     <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher = <a class="code" href="numeric_8h.html#a206397ac4e04dc6b880ca9bd3b9714ea">dtls_uint16_to_int</a>(data);
<a name="l01456"></a>01456     <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#ac913eade769e02601effc0b588fa0693">known_cipher</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher)) {
<a name="l01457"></a>01457       <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;unsupported cipher 0x%02x 0x%02x\n&quot;</span>, 
<a name="l01458"></a>01458            data[0], data[1]);
<a name="l01459"></a>01459       <span class="keywordflow">goto</span> error;
<a name="l01460"></a>01460     }
<a name="l01461"></a>01461     data += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01462"></a>01462     data_length -= <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     <span class="comment">/* Check if NULL compression was selected. We do not know any other. */</span>
<a name="l01465"></a>01465     <span class="keywordflow">if</span> (<a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(data) != <a class="code" href="dtls_8h.html#a9b0d69c07ce606ae4293939acd07be47">TLS_COMP_NULL</a>) {
<a name="l01466"></a>01466       <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;unsupported compression method 0x%02x\n&quot;</span>, data[0]);
<a name="l01467"></a>01467       <span class="keywordflow">goto</span> error;
<a name="l01468"></a>01468     }
<a name="l01469"></a>01469 
<a name="l01470"></a>01470     <span class="keywordflow">return</span> 1;
<a name="l01471"></a>01471   }
<a name="l01472"></a>01472 
<a name="l01473"></a>01473   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#ad9942d72305df29539d43b811c63ceb1">IS_HELLOVERIFY</a>(data, data_length)) {
<a name="l01474"></a>01474     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;no HelloVerify\n&quot;</span>);
<a name="l01475"></a>01475     <span class="keywordflow">return</span> 0;
<a name="l01476"></a>01476   }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478   hv = (<a class="code" href="structdtls__hello__verify__t.html">dtls_hello_verify_t</a> *)(data + <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a>);
<a name="l01479"></a>01479 
<a name="l01480"></a>01480   <span class="comment">/* FIXME: dtls_send_client_hello(ctx,peer,cookie) */</span>
<a name="l01481"></a>01481   size = <a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">DTLS_CH_LENGTH</a> + 8 + <a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(&amp;hv-&gt;<a class="code" href="structdtls__hello__verify__t.html#a87abc9ad6414896879892062d99eff0b">cookie_length</a>);
<a name="l01482"></a>01482 
<a name="l01483"></a>01483   p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#a25f0afef67a1fd8d9e3e61074d11e2f5">DTLS_HT_CLIENT_HELLO</a>, peer, 
<a name="l01484"></a>01484                 size, 0, size, p);
<a name="l01485"></a>01485 
<a name="l01486"></a>01486   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>);
<a name="l01487"></a>01487   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01488"></a>01488 
<a name="l01489"></a>01489   <span class="comment">/* we must use the same Client Random as for the previous request */</span>
<a name="l01490"></a>01490   memcpy(p, <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random, 
<a name="l01491"></a>01491      <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random));
<a name="l01492"></a>01492   p += <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random);
<a name="l01493"></a>01493 
<a name="l01494"></a>01494   <span class="comment">/* session id (length 0) */</span>
<a name="l01495"></a>01495   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, 0);
<a name="l01496"></a>01496   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l01497"></a>01497 
<a name="l01498"></a>01498   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, <a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(&amp;hv-&gt;<a class="code" href="structdtls__hello__verify__t.html#a87abc9ad6414896879892062d99eff0b">cookie_length</a>));
<a name="l01499"></a>01499   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l01500"></a>01500   memcpy(p, hv-&gt;<a class="code" href="structdtls__hello__verify__t.html#a1ac32aea725c818af79268e69f3bcb93">cookie</a>, dtls_uint8_to_int(&amp;hv-&gt;<a class="code" href="structdtls__hello__verify__t.html#a87abc9ad6414896879892062d99eff0b">cookie_length</a>));
<a name="l01501"></a>01501   p += <a class="code" href="numeric_8h.html#a48c1fd74268728bbe2964723c3f85a6d">dtls_uint8_to_int</a>(&amp;hv-&gt;<a class="code" href="structdtls__hello__verify__t.html#a87abc9ad6414896879892062d99eff0b">cookie_length</a>);
<a name="l01502"></a>01502 
<a name="l01503"></a>01503   <span class="comment">/* add known cipher(s) */</span>
<a name="l01504"></a>01504   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, 2);
<a name="l01505"></a>01505   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01506"></a>01506   
<a name="l01507"></a>01507   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59ba39a3062f136db88f648ce514a591fac8">TLS_PSK_WITH_AES_128_CCM_8</a>);
<a name="l01508"></a>01508   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l01509"></a>01509   
<a name="l01510"></a>01510   <span class="comment">/* compression method */</span>
<a name="l01511"></a>01511   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, 1);  
<a name="l01512"></a>01512   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l01513"></a>01513 
<a name="l01514"></a>01514   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, 0);
<a name="l01515"></a>01515   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517   <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01518"></a>01518 
<a name="l01519"></a>01519   res = <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, 
<a name="l01520"></a>01520           p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01521"></a>01521   <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01522"></a>01522     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot send ClientHello\n&quot;</span>);
<a name="l01523"></a>01523 
<a name="l01524"></a>01524  error: 
<a name="l01525"></a>01525   <span class="keywordflow">return</span> 0;
<a name="l01526"></a>01526 }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01529"></a><a class="code" href="dtls_8c.html#aca393c29148080d4dfa343c8ec283928">01529</a> <a class="code" href="dtls_8c.html#aca393c29148080d4dfa343c8ec283928">check_server_hellodone</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l01530"></a>01530               <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l01531"></a>01531               <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l01532"></a>01532 
<a name="l01533"></a>01533   <span class="comment">/* calculate master key, send CCS */</span>
<a name="l01534"></a>01534   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#ab2139715e3048a2d25523e09c63031b7">IS_SERVERHELLODONE</a>(data, data_length))
<a name="l01535"></a>01535     <span class="keywordflow">return</span> 0;
<a name="l01536"></a>01536   
<a name="l01537"></a>01537   <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, data, data_length);
<a name="l01538"></a>01538 
<a name="l01539"></a>01539   <span class="comment">/* set crypto context for TLS_PSK_WITH_AES_128_CCM_8 */</span>
<a name="l01540"></a>01540   <span class="comment">/* client */</span>
<a name="l01541"></a>01541   <a class="code" href="crypto_8c.html#ac13b8a8dcef3a88e3e8891e29f28b142">dtls_cipher_free</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher);
<a name="l01542"></a>01542 
<a name="l01543"></a>01543   assert(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher != <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>);
<a name="l01544"></a>01544   <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher = 
<a name="l01545"></a>01545     <a class="code" href="crypto_8c.html#acd9148cfb9ce6193629ec539d92ce2aa">dtls_cipher_new</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher,
<a name="l01546"></a>01546             <a class="code" href="crypto_8h.html#ab6a59d24d58d19406e1913c110b4fc59">dtls_kb_server_write_key</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l01547"></a>01547             <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l01548"></a>01548 
<a name="l01549"></a>01549   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher) {
<a name="l01550"></a>01550     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot create read cipher\n&quot;</span>);
<a name="l01551"></a>01551     <span class="keywordflow">return</span> 0;
<a name="l01552"></a>01552   }
<a name="l01553"></a>01553 
<a name="l01554"></a>01554   <a class="code" href="crypto_8c.html#af56d5c99667573a81f057d80d58e88b4">dtls_cipher_set_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher,
<a name="l01555"></a>01555              <a class="code" href="crypto_8h.html#acdbb2c30f60673e98d973412fde5aed3">dtls_kb_server_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l01556"></a>01556              <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l01557"></a>01557 
<a name="l01558"></a>01558   <span class="comment">/* server */</span>
<a name="l01559"></a>01559   <a class="code" href="crypto_8c.html#ac13b8a8dcef3a88e3e8891e29f28b142">dtls_cipher_free</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher);
<a name="l01560"></a>01560   
<a name="l01561"></a>01561   <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher = 
<a name="l01562"></a>01562     <a class="code" href="crypto_8c.html#acd9148cfb9ce6193629ec539d92ce2aa">dtls_cipher_new</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;cipher,
<a name="l01563"></a>01563             <a class="code" href="crypto_8h.html#a6a0f72fd69e56203b009228bf6de2e86">dtls_kb_client_write_key</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l01564"></a>01564             <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l01565"></a>01565   
<a name="l01566"></a>01566   <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher) {
<a name="l01567"></a>01567     <a class="code" href="crypto_8c.html#ac13b8a8dcef3a88e3e8891e29f28b142">dtls_cipher_free</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;read_cipher);
<a name="l01568"></a>01568     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot create write cipher\n&quot;</span>);
<a name="l01569"></a>01569     <span class="keywordflow">return</span> 0;
<a name="l01570"></a>01570   }
<a name="l01571"></a>01571   
<a name="l01572"></a>01572   <a class="code" href="crypto_8c.html#af56d5c99667573a81f057d80d58e88b4">dtls_cipher_set_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;write_cipher,
<a name="l01573"></a>01573              <a class="code" href="crypto_8h.html#a101af9642b17c1c3bbc804fdf9793e29">dtls_kb_client_iv</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)),
<a name="l01574"></a>01574              <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)));
<a name="l01575"></a>01575 
<a name="l01576"></a>01576   <span class="comment">/* send ClientKeyExchange */</span>
<a name="l01577"></a>01577   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a6723acf40fd93665a916e35c20577d6e">dtls_send_kx</a>(ctx, peer, 1) &lt; 0) {
<a name="l01578"></a>01578     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;cannot send KeyExchange message\n&quot;</span>);
<a name="l01579"></a>01579     <span class="keywordflow">return</span> 0;
<a name="l01580"></a>01580   }
<a name="l01581"></a>01581 
<a name="l01582"></a>01582   <span class="comment">/* and switch cipher suite */</span>
<a name="l01583"></a>01583   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a9cfb3c9e63f378d0d8e3d3d0c60537a5">dtls_send_ccs</a>(ctx, peer) &lt; 0) {
<a name="l01584"></a>01584     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;cannot send CCS message\n&quot;</span>);
<a name="l01585"></a>01585     <span class="keywordflow">return</span> 0;
<a name="l01586"></a>01586   }
<a name="l01587"></a>01587 
<a name="l01588"></a>01588   <a class="code" href="dtls_8c.html#a55a2fb47742a4db5d780fd5bd73bef15">SWITCH_CONFIG</a>(peer);
<a name="l01589"></a>01589   <a class="code" href="numeric_8h.html#a33d63fda9a3a1dd5b5535bbbf22f04d0">inc_uint</a>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>, peer-&gt;<a class="code" href="structdtls__peer__t.html#a9426209cc86fd29402a88fe008a0bc22">epoch</a>);
<a name="l01590"></a>01590   memset(peer-&gt;<a class="code" href="structdtls__peer__t.html#a5333b55b412ed9a5b0364f5d28d956da">rseq</a>, 0, <span class="keyword">sizeof</span>(peer-&gt;<a class="code" href="structdtls__peer__t.html#a5333b55b412ed9a5b0364f5d28d956da">rseq</a>));
<a name="l01591"></a>01591 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01592"></a>01592 <span class="preprocessor"></span>  {
<a name="l01593"></a>01593       printf(<span class="stringliteral">&quot;key_block:\n&quot;</span>);
<a name="l01594"></a>01594       printf(<span class="stringliteral">&quot;  client_MAC_secret:\t&quot;</span>);  
<a name="l01595"></a>01595       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#abb723551bf728433828e0d1607bd6b70">dtls_kb_client_mac_secret</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01596"></a>01596        <a class="code" href="crypto_8h.html#aa785c77dbbf8ea9ea470596362b312ca">dtls_kb_mac_secret_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01597"></a>01597       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599       printf(<span class="stringliteral">&quot;  server_MAC_secret:\t&quot;</span>);  
<a name="l01600"></a>01600       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#aed57fa56db7842c9275111bd995f5ae8">dtls_kb_server_mac_secret</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01601"></a>01601        <a class="code" href="crypto_8h.html#aa785c77dbbf8ea9ea470596362b312ca">dtls_kb_mac_secret_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01602"></a>01602       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01603"></a>01603 
<a name="l01604"></a>01604       printf(<span class="stringliteral">&quot;  client_write_key:\t&quot;</span>);  
<a name="l01605"></a>01605       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a6a0f72fd69e56203b009228bf6de2e86">dtls_kb_client_write_key</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01606"></a>01606        <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01607"></a>01607       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609       printf(<span class="stringliteral">&quot;  server_write_key:\t&quot;</span>);  
<a name="l01610"></a>01610       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#ab6a59d24d58d19406e1913c110b4fc59">dtls_kb_server_write_key</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01611"></a>01611        <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01612"></a>01612       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01613"></a>01613 
<a name="l01614"></a>01614       printf(<span class="stringliteral">&quot;  client_IV:\t\t&quot;</span>);  
<a name="l01615"></a>01615       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a101af9642b17c1c3bbc804fdf9793e29">dtls_kb_client_iv</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01616"></a>01616        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01617"></a>01617       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01618"></a>01618       
<a name="l01619"></a>01619       printf(<span class="stringliteral">&quot;  server_IV:\t\t&quot;</span>);  
<a name="l01620"></a>01620       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#acdbb2c30f60673e98d973412fde5aed3">dtls_kb_server_iv</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01621"></a>01621        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01622"></a>01622       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01623"></a>01623       
<a name="l01624"></a>01624 
<a name="l01625"></a>01625   }
<a name="l01626"></a>01626 <span class="preprocessor">#endif</span>
<a name="l01627"></a>01627 <span class="preprocessor"></span>
<a name="l01628"></a>01628   <span class="comment">/* Client Finished */</span>
<a name="l01629"></a>01629   {
<a name="l01630"></a>01630     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a> (<span class="stringliteral">&quot;send Finished\n&quot;</span>);
<a name="l01631"></a>01631     <span class="keywordtype">int</span> length;
<a name="l01632"></a>01632     <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>[<a class="code" href="group__HMAC.html#ga3e84ddbef6bf0084252e16e6c547e332">DTLS_HMAC_MAX</a>];
<a name="l01633"></a>01633     <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p = ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>;
<a name="l01634"></a>01634 
<a name="l01635"></a>01635     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> statebuf[DTLS_HASH_CTX_SIZE];
<a name="l01636"></a>01636 
<a name="l01637"></a>01637     <span class="comment">/* FIXME: adjust message overhead calculation */</span>
<a name="l01638"></a>01638     assert(<a class="code" href="dtls_8c.html#a727657c75e4ffea82e86e905e4640c25">msg_overhead</a>(peer, <a class="code" href="dtls_8c.html#a520419d1976b301c508721faed549b4f">DTLS_HS_LENGTH</a> + <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>) 
<a name="l01639"></a>01639        &lt; <span class="keyword">sizeof</span>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>));
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#a16b49d03e041d43b60e1b7bacf35daad">DTLS_HT_FINISHED</a>, 
<a name="l01642"></a>01642                   peer, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>, 
<a name="l01643"></a>01643                   0, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>, p);
<a name="l01644"></a>01644   
<a name="l01645"></a>01645     <span class="comment">/* temporarily store hash status for roll-back after finalize */</span>
<a name="l01646"></a>01646     memcpy(statebuf, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>, DTLS_HASH_CTX_SIZE);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648     length = <a class="code" href="dtls_8c.html#adb41bf916dc34af5cd79003a9243b727">finalize_hs_hash</a>(peer, buf);
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     <span class="comment">/* restore hash status */</span>
<a name="l01651"></a>01651     memcpy(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a3d43e1c5e1bd2aff5304cdfc549deb2c">hs_state</a>.<a class="code" href="structdtls__hs__state__t.html#a991b95919538531d730f74045e4fe3b1">hs_hash</a>, statebuf, DTLS_HASH_CTX_SIZE);
<a name="l01652"></a>01652 
<a name="l01653"></a>01653     <a class="code" href="crypto_8c.html#a5e47576e502b5a6255f1b489a4915512">dtls_prf</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;master_secret, 
<a name="l01654"></a>01654          <a class="code" href="crypto_8h.html#a2648582ddf4c82abc01d8388bd3f15db">DTLS_MASTER_SECRET_LENGTH</a>,
<a name="l01655"></a>01655          <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(client), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(client),
<a name="l01656"></a>01656          <a class="code" href="dtls_8c.html#abac8adda40bcb694e059e38f6ac115f9">PRF_LABEL</a>(finished), <a class="code" href="dtls_8c.html#a83b260e812e69f1dae18497d167770a9">PRF_LABEL_SIZE</a>(finished),
<a name="l01657"></a>01657          buf, length,
<a name="l01658"></a>01658          p, <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>);
<a name="l01659"></a>01659   
<a name="l01660"></a>01660     p += <a class="code" href="dtls_8c.html#a21644ea2de742395df1e3b3281ba4f63">DTLS_FIN_LENGTH</a>;
<a name="l01661"></a>01661 
<a name="l01662"></a>01662     <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l01663"></a>01663     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l01664"></a>01664           ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>) &lt; 0) {
<a name="l01665"></a>01665       <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;cannot send Finished message\n&quot;</span>);
<a name="l01666"></a>01666       <span class="keywordflow">return</span> 0;
<a name="l01667"></a>01667     }
<a name="l01668"></a>01668   }
<a name="l01669"></a>01669   <span class="keywordflow">return</span> 1;
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672 <span class="keywordtype">int</span>
<a name="l01673"></a><a class="code" href="dtls_8c.html#a524cdb68e70eb9244579b36c52423eb2">01673</a> <a class="code" href="dtls_8c.html#a524cdb68e70eb9244579b36c52423eb2">decrypt_verify</a>(<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer,
<a name="l01674"></a>01674            <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *packet, <span class="keywordtype">size_t</span> length,
<a name="l01675"></a>01675            <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> **cleartext, <span class="keywordtype">size_t</span> *clen) {
<a name="l01676"></a>01676   <span class="keywordtype">int</span> ok = 0;
<a name="l01677"></a>01677   
<a name="l01678"></a>01678   *cleartext = (<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *)packet + <span class="keyword">sizeof</span>(<a class="code" href="structdtls__record__header__t.html">dtls_record_header_t</a>);
<a name="l01679"></a>01679   *clen = length - <span class="keyword">sizeof</span>(<a class="code" href="structdtls__record__header__t.html">dtls_record_header_t</a>);
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;cipher == <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59bacf33de998fd00f096eebbb0742d80abd">TLS_NULL_WITH_NULL_NULL</a>) {
<a name="l01682"></a>01682     <span class="comment">/* no cipher suite selected */</span>
<a name="l01683"></a>01683     <span class="keywordflow">return</span> 1;
<a name="l01684"></a>01684   } <span class="keywordflow">else</span> {          <span class="comment">/* TLS_PSK_WITH_AES_128_CCM_8 */</span>   
<a name="l01685"></a>01685     <a class="code" href="structdtls__cipher__context__t.html">dtls_cipher_context_t</a> *cipher_context;
<a name="l01690"></a>01690 <span class="preprocessor">#define A_DATA_LEN 13</span>
<a name="l01691"></a>01691 <span class="preprocessor"></span><span class="preprocessor">#define A_DATA N</span>
<a name="l01692"></a>01692 <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> N[max(<a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>, <a class="code" href="dtls_8c.html#aee0f4f3d8541ea6ab9c204761cc6082e">A_DATA_LEN</a>)];
<a name="l01693"></a>01693     <span class="keywordtype">long</span> <span class="keywordtype">int</span> len;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695 
<a name="l01696"></a>01696     <span class="keywordflow">if</span> (*clen &lt; 16)     <span class="comment">/* need at least IV and MAC */</span>
<a name="l01697"></a>01697       <span class="keywordflow">return</span> -1;
<a name="l01698"></a>01698 
<a name="l01699"></a>01699     memset(N, 0, <a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>);
<a name="l01700"></a>01700     memcpy(N, <a class="code" href="crypto_8h.html#a859d971a5a0367b83c3058b3561ded42">dtls_kb_remote_iv</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01701"></a>01701        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="comment">/* read epoch and seq_num from message */</span>
<a name="l01704"></a>01704     memcpy(N + <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), *cleartext, 8);
<a name="l01705"></a>01705     *cleartext += 8;
<a name="l01706"></a>01706     *clen -= 8;
<a name="l01707"></a>01707 
<a name="l01708"></a>01708     cipher_context = <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;read_cipher;
<a name="l01709"></a>01709     
<a name="l01710"></a>01710     <span class="keywordflow">if</span> (!cipher_context) {
<a name="l01711"></a>01711       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;no read_cipher available!\n&quot;</span>);
<a name="l01712"></a>01712       <span class="keywordflow">return</span> 0;
<a name="l01713"></a>01713     }
<a name="l01714"></a>01714       
<a name="l01715"></a>01715 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01716"></a>01716 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;nonce:\t&quot;</span>);
<a name="l01717"></a>01717     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(N, <a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>);
<a name="l01718"></a>01718     printf(<span class="stringliteral">&quot;\nkey:\t&quot;</span>);
<a name="l01719"></a>01719     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#abebb054a3901269243c87cea036e41a9">dtls_kb_remote_write_key</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01720"></a>01720      <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01721"></a>01721     printf(<span class="stringliteral">&quot;\nciphertext:\n&quot;</span>);
<a name="l01722"></a>01722     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(*cleartext, *clen);
<a name="l01723"></a>01723     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01724"></a>01724 <span class="preprocessor">#endif</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>
<a name="l01726"></a>01726     <a class="code" href="crypto_8c.html#af56d5c99667573a81f057d80d58e88b4">dtls_cipher_set_iv</a>(cipher_context, N, <a class="code" href="ccm_8h.html#a5c46c97c6c3ef5d4e5bd616dbd064859">DTLS_CCM_BLOCKSIZE</a>);
<a name="l01727"></a>01727 
<a name="l01728"></a>01728     <span class="comment">/* re-use N to create additional data according to RFC 5246, Section 6.2.3.3:</span>
<a name="l01729"></a>01729 <span class="comment">     * </span>
<a name="l01730"></a>01730 <span class="comment">     * additional_data = seq_num + TLSCompressed.type +</span>
<a name="l01731"></a>01731 <span class="comment">     *                   TLSCompressed.version + TLSCompressed.length;</span>
<a name="l01732"></a>01732 <span class="comment">     */</span>
<a name="l01733"></a>01733     memcpy(<a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a>, &amp;<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(packet)-&gt;epoch, 8); <span class="comment">/* epoch and seq_num */</span>
<a name="l01734"></a>01734     memcpy(<a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a> + 8,  &amp;<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(packet)-&gt;content_type, 3); <span class="comment">/* type and version */</span>
<a name="l01735"></a>01735     <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(<a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a> + 11, *clen - 8); <span class="comment">/* length without nonce_explicit */</span>
<a name="l01736"></a>01736 
<a name="l01737"></a>01737     len = <a class="code" href="crypto_8c.html#adabb4086b1c887827dc5241f01d1e7b5">dtls_decrypt</a>(cipher_context, *cleartext, *clen, *cleartext,
<a name="l01738"></a>01738                <a class="code" href="dtls_8c.html#a1e9a072d99b3a8fd755ce6283bc61018">A_DATA</a>, <a class="code" href="dtls_8c.html#aee0f4f3d8541ea6ab9c204761cc6082e">A_DATA_LEN</a>);
<a name="l01739"></a>01739 
<a name="l01740"></a>01740     ok = len &gt;= 0;
<a name="l01741"></a>01741     <span class="keywordflow">if</span> (!ok)
<a name="l01742"></a>01742       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;decryption failed\n&quot;</span>);
<a name="l01743"></a>01743     <span class="keywordflow">else</span> {
<a name="l01744"></a>01744 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01745"></a>01745 <span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;decrypt_verify(): found %ld bytes cleartext\n&quot;</span>, len);
<a name="l01746"></a>01746 <span class="preprocessor">#endif</span>
<a name="l01747"></a>01747 <span class="preprocessor"></span>      *clen = len;
<a name="l01748"></a>01748     }
<a name="l01749"></a>01749 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01750"></a>01750 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;\ncleartext:\n&quot;</span>);
<a name="l01751"></a>01751     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(*cleartext, *clen);
<a name="l01752"></a>01752     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01753"></a>01753 <span class="preprocessor">#endif</span>
<a name="l01754"></a>01754 <span class="preprocessor"></span>  }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756   <span class="keywordflow">return</span> ok;
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759 
<a name="l01760"></a>01760 <span class="keywordtype">int</span>
<a name="l01761"></a><a class="code" href="dtls_8c.html#a3f971dd7bce69824045ec16313b88b8d">01761</a> <a class="code" href="dtls_8c.html#a3f971dd7bce69824045ec16313b88b8d">handle_handshake</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, 
<a name="l01762"></a>01762          <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *record_header, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l01763"></a>01763 
<a name="l01764"></a>01764   <span class="comment">/* The following switch construct handles the given message with</span>
<a name="l01765"></a>01765 <span class="comment">   * respect to the current internal state for this peer. In case of</span>
<a name="l01766"></a>01766 <span class="comment">   * error, it is left with return 0. */</span>
<a name="l01767"></a>01767 
<a name="l01768"></a>01768   <span class="keywordflow">switch</span> (peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a>) {
<a name="l01769"></a>01769 
<a name="l01770"></a>01770   <span class="comment">/************************************************************************</span>
<a name="l01771"></a>01771 <span class="comment">   * Client states</span>
<a name="l01772"></a>01772 <span class="comment">   ************************************************************************/</span>
<a name="l01773"></a>01773 
<a name="l01774"></a>01774   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a1a76f1e49c80d22df9673f8471d1ec53">DTLS_STATE_CLIENTHELLO</a>:
<a name="l01775"></a>01775     <span class="comment">/* here we expect a HelloVerify or ServerHello */</span>
<a name="l01776"></a>01776 
<a name="l01777"></a>01777     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLS_STATE_CLIENTHELLO\n&quot;</span>);
<a name="l01778"></a>01778     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#afcc64c0abfd9b157b71a47e5a5a78b26">check_server_hello</a>(ctx, peer, data, data_length)) {
<a name="l01779"></a>01779       peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a5c55da9c6de8eb986de811cf2135a1a0">DTLS_STATE_WAIT_SERVERHELLODONE</a>;
<a name="l01780"></a>01780     <span class="comment">/* update_hs_hash(peer, data, data_length); */</span>
<a name="l01781"></a>01781     }
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="keywordflow">break</span>;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a5c55da9c6de8eb986de811cf2135a1a0">DTLS_STATE_WAIT_SERVERHELLODONE</a>:
<a name="l01786"></a>01786     <span class="comment">/* expect a ServerHelloDone */</span>
<a name="l01787"></a>01787 
<a name="l01788"></a>01788     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLS_STATE_WAIT_SERVERHELLODONE\n&quot;</span>);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#aca393c29148080d4dfa343c8ec283928">check_server_hellodone</a>(ctx, peer, data, data_length)) {
<a name="l01791"></a>01791       peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a840696bc7b6b97f89f5a75092f53e727">DTLS_STATE_WAIT_SERVERFINISHED</a>;
<a name="l01792"></a>01792       <span class="comment">/* update_hs_hash(peer, data, data_length); */</span>
<a name="l01793"></a>01793     }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795     <span class="keywordflow">break</span>;
<a name="l01796"></a>01796 
<a name="l01797"></a>01797   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a840696bc7b6b97f89f5a75092f53e727">DTLS_STATE_WAIT_SERVERFINISHED</a>:
<a name="l01798"></a>01798     <span class="comment">/* expect a Finished message from server */</span>
<a name="l01799"></a>01799 
<a name="l01800"></a>01800     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLS_STATE_WAIT_SERVERFINISHED\n&quot;</span>);
<a name="l01801"></a>01801     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a476fab7695f3f424bd33263e36ceefeb">check_finished</a>(ctx, peer, record_header, data, data_length)) {
<a name="l01802"></a>01802       <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;finished!\n&quot;</span>);
<a name="l01803"></a>01803       peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a953a6aabd0aff0492df164e79815b122">DTLS_STATE_CONNECTED</a>;
<a name="l01804"></a>01804     }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     <span class="keywordflow">break</span>;
<a name="l01807"></a>01807 
<a name="l01808"></a>01808   <span class="comment">/************************************************************************</span>
<a name="l01809"></a>01809 <span class="comment">   * Server states</span>
<a name="l01810"></a>01810 <span class="comment">   ************************************************************************/</span>
<a name="l01811"></a>01811 
<a name="l01812"></a>01812   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a59bd63d1841158dd78e9f9170905ba19">DTLS_STATE_SERVERHELLO</a>:
<a name="l01813"></a>01813     <span class="comment">/* here we expect a ClientHello */</span>
<a name="l01814"></a>01814     <span class="comment">/* handle ClientHello, update msg and msglen and goto next if not finished */</span>
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLS_STATE_SERVERHELLO\n&quot;</span>);
<a name="l01817"></a>01817     <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#a1ca57775f168ceeb75dd1d4cb3bea82a">check_client_keyexchange</a>(ctx, peer, data, data_length)) {
<a name="l01818"></a>01818       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;check_client_keyexchange failed (%d, %d)\n&quot;</span>, data_length, data[0]);
<a name="l01819"></a>01819       <span class="keywordflow">return</span> 0;         <span class="comment">/* drop it, whatever it is */</span>
<a name="l01820"></a>01820     }
<a name="l01821"></a>01821     
<a name="l01822"></a>01822     <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, data, data_length);
<a name="l01823"></a>01823     peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35aff6515382d9f745c35fa216004227c79">DTLS_STATE_KEYEXCHANGE</a>;
<a name="l01824"></a>01824     <span class="keywordflow">break</span>;
<a name="l01825"></a>01825 
<a name="l01826"></a>01826   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a8c1ffc1652e7c5ba25239fe1f3a430ba">DTLS_STATE_WAIT_FINISHED</a>:
<a name="l01827"></a>01827     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLS_STATE_WAIT_FINISHED\n&quot;</span>);
<a name="l01828"></a>01828     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a476fab7695f3f424bd33263e36ceefeb">check_finished</a>(ctx, peer, record_header, data, data_length)) {
<a name="l01829"></a>01829       <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;finished!\n&quot;</span>);
<a name="l01830"></a>01830     
<a name="l01831"></a>01831       <span class="comment">/* send ServerFinished */</span>
<a name="l01832"></a>01832       <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, data, data_length);
<a name="l01833"></a>01833 
<a name="l01834"></a>01834       <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a47c13c41aeab184fdc1ee36b30121262">dtls_send_server_finished</a>(ctx, peer) &gt; 0) {
<a name="l01835"></a>01835     peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a953a6aabd0aff0492df164e79815b122">DTLS_STATE_CONNECTED</a>;
<a name="l01836"></a>01836       } <span class="keywordflow">else</span> {
<a name="l01837"></a>01837     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;sending server Finished failed\n&quot;</span>);
<a name="l01838"></a>01838       }
<a name="l01839"></a>01839     } <span class="keywordflow">else</span> {
<a name="l01840"></a>01840       <span class="comment">/* send alert */</span>
<a name="l01841"></a>01841     }
<a name="l01842"></a>01842     <span class="keywordflow">break</span>;
<a name="l01843"></a>01843       
<a name="l01844"></a>01844   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a953a6aabd0aff0492df164e79815b122">DTLS_STATE_CONNECTED</a>:
<a name="l01845"></a>01845     <span class="comment">/* At this point, we have a good relationship with this peer. This</span>
<a name="l01846"></a>01846 <span class="comment">     * state is left for re-negotiation of key material. */</span>
<a name="l01847"></a>01847     
<a name="l01848"></a>01848     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;DTLS_STATE_CONNECTED\n&quot;</span>);
<a name="l01849"></a>01849 
<a name="l01850"></a>01850     <span class="comment">/* renegotiation */</span>
<a name="l01851"></a>01851     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#ae33d80799a71860bb4399853ea4c3093">dtls_verify_peer</a>(ctx, peer, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, 
<a name="l01852"></a>01852              record_header, data, data_length) &gt; 0) {
<a name="l01853"></a>01853 
<a name="l01854"></a>01854       <a class="code" href="dtls_8c.html#a82181208ec1e9f42896f0606e0036c1d">clear_hs_hash</a>(peer);
<a name="l01855"></a>01855 
<a name="l01856"></a>01856       <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#a84609d3e600abbd6056ead84b7dbd8d9">dtls_update_parameters</a>(ctx, peer, data, data_length)) {
<a name="l01857"></a>01857     
<a name="l01858"></a>01858     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;error updating security parameters\n&quot;</span>);
<a name="l01859"></a>01859     <a class="code" href="dtls_8c.html#a1829e5474862cb944e9f9975ff6bd9bf">dtls_alert</a>(ctx, peer, <a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871fa0f670b55dcb4ab291b869827d3c62ee7">DTLS_ALERT_LEVEL_WARNING</a>, 
<a name="l01860"></a>01860            <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbda8939a5d1777bf0dbdd8fa44e335137ab">DTLS_ALERT_NO_RENEGOTIATION</a>);
<a name="l01861"></a>01861     <span class="keywordflow">return</span> 0;
<a name="l01862"></a>01862       }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864       <span class="comment">/* update finish MAC */</span>
<a name="l01865"></a>01865       <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, data, data_length); 
<a name="l01866"></a>01866 
<a name="l01867"></a>01867       <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#ad629df3066c0352a4053c95a92b46d49">dtls_send_server_hello</a>(ctx, peer) &gt; 0)
<a name="l01868"></a>01868     peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a59bd63d1841158dd78e9f9170905ba19">DTLS_STATE_SERVERHELLO</a>;
<a name="l01869"></a>01869     
<a name="l01870"></a>01870       <span class="comment">/* after sending the ServerHelloDone, we expect the </span>
<a name="l01871"></a>01871 <span class="comment">       * ClientKeyExchange (possibly containing the PSK id),</span>
<a name="l01872"></a>01872 <span class="comment">       * followed by a ChangeCipherSpec and an encrypted Finished.</span>
<a name="l01873"></a>01873 <span class="comment">       */</span>
<a name="l01874"></a>01874     }
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="keywordflow">break</span>;
<a name="l01877"></a>01877     
<a name="l01878"></a>01878   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35afa23f2a7b1313abfb472a55a17cc26b8">DTLS_STATE_INIT</a>:       <span class="comment">/* these states should not occur here */</span>
<a name="l01879"></a>01879   <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35aff6515382d9f745c35fa216004227c79">DTLS_STATE_KEYEXCHANGE</a>:
<a name="l01880"></a>01880   <span class="keywordflow">default</span>:
<a name="l01881"></a>01881     <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da3537fbf756308b6267dd4354615eb413">LOG_CRIT</a>, <span class="stringliteral">&quot;unhandled state %d\n&quot;</span>, peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a>);
<a name="l01882"></a>01882     assert(0);
<a name="l01883"></a>01883   }
<a name="l01884"></a>01884 
<a name="l01885"></a>01885   <span class="keywordflow">return</span> 1;
<a name="l01886"></a>01886 }
<a name="l01887"></a>01887 
<a name="l01888"></a>01888 <span class="keywordtype">int</span>
<a name="l01889"></a><a class="code" href="dtls_8c.html#a193a27c41c92947c484e2d96c6a55c02">01889</a> <a class="code" href="dtls_8c.html#a193a27c41c92947c484e2d96c6a55c02">handle_ccs</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, 
<a name="l01890"></a>01890        <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *record_header, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l01891"></a>01891 
<a name="l01892"></a>01892   <span class="comment">/* A CCS message is handled after a KeyExchange message was</span>
<a name="l01893"></a>01893 <span class="comment">   * received from the client. When security parameters have been</span>
<a name="l01894"></a>01894 <span class="comment">   * updated successfully and a ChangeCipherSpec message was sent</span>
<a name="l01895"></a>01895 <span class="comment">   * by ourself, the security context is switched and the record</span>
<a name="l01896"></a>01896 <span class="comment">   * sequence number is reset. */</span>
<a name="l01897"></a>01897   
<a name="l01898"></a>01898   <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> != <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35aff6515382d9f745c35fa216004227c79">DTLS_STATE_KEYEXCHANGE</a>
<a name="l01899"></a>01899       || !<a class="code" href="dtls_8c.html#ac236d1b48c77c19c7f683f17cfd9955d">check_ccs</a>(ctx, peer, record_header, data, data_length)) {
<a name="l01900"></a>01900     <span class="comment">/* signal error? */</span>
<a name="l01901"></a>01901     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;expected ChangeCipherSpec during handshake\n&quot;</span>);
<a name="l01902"></a>01902     <span class="keywordflow">return</span> 0;
<a name="l01903"></a>01903 
<a name="l01904"></a>01904   }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906   <span class="comment">/* send change cipher spec message and switch to new configuration */</span>
<a name="l01907"></a>01907   <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a9cfb3c9e63f378d0d8e3d3d0c60537a5">dtls_send_ccs</a>(ctx, peer) &lt; 0) {
<a name="l01908"></a>01908     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot send CCS message&quot;</span>);
<a name="l01909"></a>01909     <span class="keywordflow">return</span> 0;
<a name="l01910"></a>01910   } 
<a name="l01911"></a>01911   
<a name="l01912"></a>01912   <a class="code" href="dtls_8c.html#a55a2fb47742a4db5d780fd5bd73bef15">SWITCH_CONFIG</a>(peer);
<a name="l01913"></a>01913   <a class="code" href="numeric_8h.html#a33d63fda9a3a1dd5b5535bbbf22f04d0">inc_uint</a>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>, peer-&gt;<a class="code" href="structdtls__peer__t.html#a9426209cc86fd29402a88fe008a0bc22">epoch</a>);
<a name="l01914"></a>01914   memset(peer-&gt;<a class="code" href="structdtls__peer__t.html#a5333b55b412ed9a5b0364f5d28d956da">rseq</a>, 0, <span class="keyword">sizeof</span>(peer-&gt;<a class="code" href="structdtls__peer__t.html#a5333b55b412ed9a5b0364f5d28d956da">rseq</a>));
<a name="l01915"></a>01915   
<a name="l01916"></a>01916   peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a8c1ffc1652e7c5ba25239fe1f3a430ba">DTLS_STATE_WAIT_FINISHED</a>;
<a name="l01917"></a>01917 
<a name="l01918"></a>01918 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01919"></a>01919 <span class="preprocessor"></span>  {
<a name="l01920"></a>01920       printf(<span class="stringliteral">&quot;key_block:\n&quot;</span>);
<a name="l01921"></a>01921       printf(<span class="stringliteral">&quot;  client_MAC_secret:\t&quot;</span>);  
<a name="l01922"></a>01922       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#abb723551bf728433828e0d1607bd6b70">dtls_kb_client_mac_secret</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01923"></a>01923        <a class="code" href="crypto_8h.html#aa785c77dbbf8ea9ea470596362b312ca">dtls_kb_mac_secret_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01924"></a>01924       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01925"></a>01925 
<a name="l01926"></a>01926       printf(<span class="stringliteral">&quot;  server_MAC_secret:\t&quot;</span>);  
<a name="l01927"></a>01927       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#aed57fa56db7842c9275111bd995f5ae8">dtls_kb_server_mac_secret</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01928"></a>01928        <a class="code" href="crypto_8h.html#aa785c77dbbf8ea9ea470596362b312ca">dtls_kb_mac_secret_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01929"></a>01929       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01930"></a>01930 
<a name="l01931"></a>01931       printf(<span class="stringliteral">&quot;  client_write_key:\t&quot;</span>);  
<a name="l01932"></a>01932       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a6a0f72fd69e56203b009228bf6de2e86">dtls_kb_client_write_key</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01933"></a>01933        <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01934"></a>01934       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936       printf(<span class="stringliteral">&quot;  server_write_key:\t&quot;</span>);  
<a name="l01937"></a>01937       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#ab6a59d24d58d19406e1913c110b4fc59">dtls_kb_server_write_key</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01938"></a>01938        <a class="code" href="crypto_8h.html#a338dccdef115054584498f8c0394db57">dtls_kb_key_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01939"></a>01939       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01940"></a>01940 
<a name="l01941"></a>01941       printf(<span class="stringliteral">&quot;  client_IV:\t\t&quot;</span>);  
<a name="l01942"></a>01942       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#a101af9642b17c1c3bbc804fdf9793e29">dtls_kb_client_iv</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01943"></a>01943        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01944"></a>01944       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01945"></a>01945       
<a name="l01946"></a>01946       printf(<span class="stringliteral">&quot;  server_IV:\t\t&quot;</span>);  
<a name="l01947"></a>01947       <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<a class="code" href="crypto_8h.html#acdbb2c30f60673e98d973412fde5aed3">dtls_kb_server_iv</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)), 
<a name="l01948"></a>01948        <a class="code" href="crypto_8h.html#ac11c288d86529d05f57205a744cee578">dtls_kb_iv_size</a>(<a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)));
<a name="l01949"></a>01949       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01950"></a>01950       
<a name="l01951"></a>01951 
<a name="l01952"></a>01952   }
<a name="l01953"></a>01953 <span class="preprocessor">#endif</span>
<a name="l01954"></a>01954 <span class="preprocessor"></span>
<a name="l01955"></a>01955   <span class="keywordflow">return</span> 1;
<a name="l01956"></a>01956 }  
<a name="l01957"></a>01957 
<a name="l01962"></a>01962 <span class="keywordtype">int</span>
<a name="l01963"></a><a class="code" href="dtls_8c.html#a028ee7b63487aa7d6e19463f4383dc46">01963</a> <a class="code" href="dtls_8c.html#a028ee7b63487aa7d6e19463f4383dc46">handle_alert</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer, 
<a name="l01964"></a>01964          <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *record_header, <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data, <span class="keywordtype">size_t</span> data_length) {
<a name="l01965"></a>01965   <span class="keywordtype">int</span> free_peer = 0;        <span class="comment">/* indicates whether to free peer */</span>
<a name="l01966"></a>01966 
<a name="l01967"></a>01967   <span class="keywordflow">if</span> (data_length &lt; 2)
<a name="l01968"></a>01968     <span class="keywordflow">return</span> 0;
<a name="l01969"></a>01969 
<a name="l01970"></a>01970   <a class="code" href="debug_8h.html#a6576e6f80131b01ef1bca232282ef26b">info</a>(<span class="stringliteral">&quot;** Alert: level %d, description %d\n&quot;</span>, data[0], data[1]);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972   <span class="comment">/* The peer object is invalidated for FATAL alerts and close</span>
<a name="l01973"></a>01973 <span class="comment">   * notifies. This is done in two steps.: First, remove the object</span>
<a name="l01974"></a>01974 <span class="comment">   * from our list of peers. After that, the event handler callback is</span>
<a name="l01975"></a>01975 <span class="comment">   * invoked with the still existing peer object. Finally, the storage</span>
<a name="l01976"></a>01976 <span class="comment">   * used by peer is released.</span>
<a name="l01977"></a>01977 <span class="comment">   */</span>
<a name="l01978"></a>01978   <span class="keywordflow">if</span> (data[0] == <a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871fabd07bcf63c24aa5f1b9706a4197ceaf4">DTLS_ALERT_LEVEL_FATAL</a> || data[1] == <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbdaed5c5f79854fde6049bfa46955f166b0">DTLS_ALERT_CLOSE</a>) {
<a name="l01979"></a>01979     <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;%d invalidate peer\n&quot;</span>, data[1]);
<a name="l01980"></a>01980     
<a name="l01981"></a>01981 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l01982"></a>01982 <span class="preprocessor"></span>    <a class="code" href="dtls_8c.html#a0844494b0b76acb7bcf832ae74fb25c0">HASH_DEL_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, peer);
<a name="l01983"></a>01983 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l01984"></a>01984     <a class="code" href="t__list_8h.html#a10de2120be61f445c5989c983c1e133b">list_remove</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, peer);
<a name="l01985"></a>01985 
<a name="l01986"></a>01986 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l01987"></a>01987 <span class="preprocessor"></span>    <a class="code" href="debug_8c.html#a1f464e950a4fa11e8821b5c725921a15">PRINTF</a>(<span class="stringliteral">&quot;removed peer [&quot;</span>);
<a name="l01988"></a>01988     PRINT6ADDR(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>.addr);
<a name="l01989"></a>01989     <a class="code" href="debug_8c.html#a1f464e950a4fa11e8821b5c725921a15">PRINTF</a>(<span class="stringliteral">&quot;]:%d\n&quot;</span>, uip_ntohs(peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>.port));
<a name="l01990"></a>01990 <span class="preprocessor">#endif</span>
<a name="l01991"></a>01991 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l01992"></a>01992 
<a name="l01993"></a>01993     free_peer = 1;
<a name="l01994"></a>01994 
<a name="l01995"></a>01995   }
<a name="l01996"></a>01996 
<a name="l01997"></a>01997   (void)<a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, event, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, 
<a name="l01998"></a>01998          (<a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871f">dtls_alert_level_t</a>)data[0], (<span class="keywordtype">unsigned</span> short)data[1]);
<a name="l01999"></a>01999   <span class="keywordflow">switch</span> (data[1]) {
<a name="l02000"></a>02000   <span class="keywordflow">case</span> <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbdaed5c5f79854fde6049bfa46955f166b0">DTLS_ALERT_CLOSE</a>:
<a name="l02001"></a>02001     <span class="comment">/* If state is DTLS_STATE_CLOSING, we have already sent a</span>
<a name="l02002"></a>02002 <span class="comment">     * close_notify so, do not send that again. */</span>
<a name="l02003"></a>02003     <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> != <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a4aa3fcce37191fc2a915aa330efd381b">DTLS_STATE_CLOSING</a>) {
<a name="l02004"></a>02004       peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a4aa3fcce37191fc2a915aa330efd381b">DTLS_STATE_CLOSING</a>;
<a name="l02005"></a>02005       <a class="code" href="dtls_8c.html#a1829e5474862cb944e9f9975ff6bd9bf">dtls_alert</a>(ctx, peer, <a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871fabd07bcf63c24aa5f1b9706a4197ceaf4">DTLS_ALERT_LEVEL_FATAL</a>, <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbdaed5c5f79854fde6049bfa46955f166b0">DTLS_ALERT_CLOSE</a>);
<a name="l02006"></a>02006     } <span class="keywordflow">else</span>
<a name="l02007"></a>02007       peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a88bc0f5ff63003f57a59700dc4b55553">DTLS_STATE_CLOSED</a>;
<a name="l02008"></a>02008     <span class="keywordflow">break</span>;
<a name="l02009"></a>02009   <span class="keywordflow">default</span>:
<a name="l02010"></a>02010     ;
<a name="l02011"></a>02011   }
<a name="l02012"></a>02012   
<a name="l02013"></a>02013   <span class="keywordflow">if</span> (free_peer) {
<a name="l02014"></a>02014     <a class="code" href="dtls_8c.html#a3bcaa90e5f3f58c6b9b9a2466f7c6707">dtls_stop_retransmission</a>(ctx, peer);
<a name="l02015"></a>02015     <a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">dtls_free_peer</a>(peer);
<a name="l02016"></a>02016   }
<a name="l02017"></a>02017 
<a name="l02018"></a>02018   <span class="keywordflow">return</span> free_peer;
<a name="l02019"></a>02019 }
<a name="l02020"></a>02020 
<a name="l02024"></a>02024 <span class="keywordtype">int</span>
<a name="l02025"></a><a class="code" href="dtls_8h.html#ae272fea7269714fe7a67d6da64961731">02025</a> <a class="code" href="dtls_8c.html#ae272fea7269714fe7a67d6da64961731">dtls_handle_message</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, 
<a name="l02026"></a>02026             session_t *session,
<a name="l02027"></a>02027             <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *msg, <span class="keywordtype">int</span> msglen) {
<a name="l02028"></a>02028   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer = NULL;
<a name="l02029"></a>02029   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rlen;        <span class="comment">/* record length */</span>
<a name="l02030"></a>02030   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data;          <span class="comment">/* (decrypted) payload */</span>
<a name="l02031"></a>02031   <span class="keywordtype">size_t</span> data_length;       <span class="comment">/* length of decrypted payload </span>
<a name="l02032"></a>02032 <span class="comment">                   (without MAC and padding) */</span>
<a name="l02033"></a>02033 
<a name="l02034"></a>02034   <span class="comment">/* check if we have DTLS state for addr/port/ifindex */</span>
<a name="l02035"></a>02035 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l02036"></a>02036 <span class="preprocessor"></span>  <a class="code" href="dtls_8c.html#a0ce6e5416f5479558116b881d3eb1ad6">HASH_FIND_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, session, peer);
<a name="l02037"></a>02037   {
<a name="l02038"></a>02038     <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *p = NULL;
<a name="l02039"></a>02039     <a class="code" href="dtls_8c.html#a0ce6e5416f5479558116b881d3eb1ad6">HASH_FIND_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, session, p);
<a name="l02040"></a>02040 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l02041"></a>02041 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!p) {
<a name="l02042"></a>02042       printf(<span class="stringliteral">&quot;dtls_handle_message: PEER NOT FOUND\n&quot;</span>);
<a name="l02043"></a>02043       {
<a name="l02044"></a>02044     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> addrbuf[72];
<a name="l02045"></a>02045     <a class="code" href="debug_8c.html#adf05a794730eda4e59d1dbb98897eb02">dsrv_print_addr</a>(session, addrbuf, <span class="keyword">sizeof</span>(addrbuf));
<a name="l02046"></a>02046     printf(<span class="stringliteral">&quot;  %s\n&quot;</span>, addrbuf);
<a name="l02047"></a>02047     <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)session, <span class="keyword">sizeof</span>(session_t));
<a name="l02048"></a>02048     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02049"></a>02049       }
<a name="l02050"></a>02050     } <span class="keywordflow">else</span> 
<a name="l02051"></a>02051       printf(<span class="stringliteral">&quot;dtls_handle_message: FOUND PEER\n&quot;</span>);
<a name="l02052"></a>02052 <span class="preprocessor">#endif </span><span class="comment">/* NDEBUG */</span>
<a name="l02053"></a>02053   }
<a name="l02054"></a>02054 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02055"></a>02055   <span class="keywordflow">for</span> (peer = <a class="code" href="t__list_8h.html#adb42e31bb4fe0df6ec1aa3494902968d">list_head</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>); 
<a name="l02056"></a>02056        peer &amp;&amp; !<a class="code" href="global_8h.html#a72a41dbeec2aa1c999b7f3a38f5b41e5">dtls_session_equals</a>(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, session);
<a name="l02057"></a>02057        peer = <a class="code" href="t__list_8h.html#ae7f0bdad2409695760ffd8de55b6a99b">list_item_next</a>(peer))
<a name="l02058"></a>02058     ;
<a name="l02059"></a>02059 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02060"></a>02060 
<a name="l02061"></a>02061   <span class="keywordflow">if</span> (!peer) {          
<a name="l02062"></a>02062 
<a name="l02063"></a>02063     <span class="comment">/* get first record from client message */</span>
<a name="l02064"></a>02064     rlen = <a class="code" href="dtls_8c.html#a6ecde1c9d9b4ad41fe6a0b793e205fd2">is_record</a>(msg, msglen);
<a name="l02065"></a>02065     assert(rlen &lt;= msglen);
<a name="l02066"></a>02066 
<a name="l02067"></a>02067     <span class="keywordflow">if</span> (!rlen) {
<a name="l02068"></a>02068 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l02069"></a>02069 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (msglen &gt; 3) 
<a name="l02070"></a>02070     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dropped invalid message %02x%02x%02x%02x\n&quot;</span>, msg[0], msg[1], msg[2], msg[3]);
<a name="l02071"></a>02071       <span class="keywordflow">else</span>
<a name="l02072"></a>02072     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;dropped invalid message (less than four bytes)\n&quot;</span>);
<a name="l02073"></a>02073 <span class="preprocessor">#endif</span>
<a name="l02074"></a>02074 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 0;
<a name="l02075"></a>02075     }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077     <span class="comment">/* is_record() ensures that msg contains at least a record header */</span>
<a name="l02078"></a>02078     data = msg + <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>;
<a name="l02079"></a>02079     data_length = rlen - <a class="code" href="dtls_8c.html#ae97c368900c13dc7074c09e8848afa8f">DTLS_RH_LENGTH</a>;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081     <span class="comment">/* When no DTLS state exists for this peer, we only allow a</span>
<a name="l02082"></a>02082 <span class="comment">       Client Hello message with </span>
<a name="l02083"></a>02083 <span class="comment">        </span>
<a name="l02084"></a>02084 <span class="comment">       a) a valid cookie, or </span>
<a name="l02085"></a>02085 <span class="comment">       b) no cookie.</span>
<a name="l02086"></a>02086 <span class="comment"></span>
<a name="l02087"></a>02087 <span class="comment">       Anything else will be rejected. Fragementation is not allowed</span>
<a name="l02088"></a>02088 <span class="comment">       here as it would require peer state as well.</span>
<a name="l02089"></a>02089 <span class="comment">    */</span>
<a name="l02090"></a>02090 
<a name="l02091"></a>02091     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#ae33d80799a71860bb4399853ea4c3093">dtls_verify_peer</a>(ctx, NULL, session, msg, data, data_length) &lt;= 0) {
<a name="l02092"></a>02092       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot verify peer\n&quot;</span>);
<a name="l02093"></a>02093       <span class="keywordflow">return</span> -1;
<a name="l02094"></a>02094     }
<a name="l02095"></a>02095     
<a name="l02096"></a>02096     <span class="comment">/* msg contains a Client Hello with a valid cookie, so we can</span>
<a name="l02097"></a>02097 <span class="comment">       safely create the server state machine and continue with</span>
<a name="l02098"></a>02098 <span class="comment">       the handshake. */</span>
<a name="l02099"></a>02099 
<a name="l02100"></a>02100     peer = <a class="code" href="dtls_8c.html#a24a60717e58c8335b1324ba6ef90601a">dtls_new_peer</a>(ctx, session);
<a name="l02101"></a>02101     <span class="keywordflow">if</span> (!peer) {
<a name="l02102"></a>02102       <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;cannot create peer&quot;</span>);
<a name="l02103"></a>02103       <span class="comment">/* FIXME: signal internal error */</span>
<a name="l02104"></a>02104       <span class="keywordflow">return</span> -1;
<a name="l02105"></a>02105     }
<a name="l02106"></a>02106 
<a name="l02107"></a>02107     <span class="comment">/* Initialize record sequence number to 1 for new peers. The first</span>
<a name="l02108"></a>02108 <span class="comment">     * record with sequence number 0 is a stateless Hello Verify Request.</span>
<a name="l02109"></a>02109 <span class="comment">     */</span>
<a name="l02110"></a>02110     peer-&gt;<a class="code" href="structdtls__peer__t.html#a5333b55b412ed9a5b0364f5d28d956da">rseq</a>[5] = 1;
<a name="l02111"></a>02111 
<a name="l02112"></a>02112     <span class="comment">/* First negotiation step: check for PSK</span>
<a name="l02113"></a>02113 <span class="comment">     *</span>
<a name="l02114"></a>02114 <span class="comment">     * Note that we already have checked that msg is a Handshake</span>
<a name="l02115"></a>02115 <span class="comment">     * message containing a ClientHello. dtls_get_cipher() therefore</span>
<a name="l02116"></a>02116 <span class="comment">     * does not check again.</span>
<a name="l02117"></a>02117 <span class="comment">     */</span>
<a name="l02118"></a>02118     <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#a84609d3e600abbd6056ead84b7dbd8d9">dtls_update_parameters</a>(ctx, peer, 
<a name="l02119"></a>02119             msg + DTLS_RH_LENGTH, rlen - DTLS_RH_LENGTH)) {
<a name="l02120"></a>02120 
<a name="l02121"></a>02121       <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;error updating security parameters\n&quot;</span>);
<a name="l02122"></a>02122       <span class="comment">/* FIXME: send handshake failure Alert */</span>
<a name="l02123"></a>02123       <a class="code" href="dtls_8c.html#a1829e5474862cb944e9f9975ff6bd9bf">dtls_alert</a>(ctx, peer, <a class="code" href="alert_8h.html#ab6264d1b950719f1c2e00b122cad871fabd07bcf63c24aa5f1b9706a4197ceaf4">DTLS_ALERT_LEVEL_FATAL</a>, 
<a name="l02124"></a>02124          <a class="code" href="alert_8h.html#a41c9f2d4035bc6bf5a0f437842a9ecbdaea5ed33e912421eb48afb73ce0a6014d">DTLS_ALERT_HANDSHAKE_FAILURE</a>);
<a name="l02125"></a>02125       <a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">dtls_free_peer</a>(peer);
<a name="l02126"></a>02126       <span class="keywordflow">return</span> -1;
<a name="l02127"></a>02127     }
<a name="l02128"></a>02128 
<a name="l02129"></a>02129 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l02130"></a>02130 <span class="preprocessor"></span>    <a class="code" href="dtls_8c.html#acf0d50c9f224c0677988f13e947e9523">HASH_ADD_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, session, peer);
<a name="l02131"></a>02131 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02132"></a>02132     <a class="code" href="t__list_8h.html#aee4e6fc5d9a6133555e7373c654b2120">list_add</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, peer);
<a name="l02133"></a>02133 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02134"></a>02134     
<a name="l02135"></a>02135     <span class="comment">/* update finish MAC */</span>
<a name="l02136"></a>02136     <a class="code" href="dtls_8c.html#a3db09acb5894f17f4745d7556555bea7">update_hs_hash</a>(peer, msg + DTLS_RH_LENGTH, rlen - DTLS_RH_LENGTH); 
<a name="l02137"></a>02137  
<a name="l02138"></a>02138     <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#ad629df3066c0352a4053c95a92b46d49">dtls_send_server_hello</a>(ctx, peer) &gt; 0)
<a name="l02139"></a>02139       peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a59bd63d1841158dd78e9f9170905ba19">DTLS_STATE_SERVERHELLO</a>;
<a name="l02140"></a>02140     
<a name="l02141"></a>02141     <span class="comment">/* after sending the ServerHelloDone, we expect the </span>
<a name="l02142"></a>02142 <span class="comment">     * ClientKeyExchange (possibly containing the PSK id),</span>
<a name="l02143"></a>02143 <span class="comment">     * followed by a ChangeCipherSpec and an encrypted Finished.</span>
<a name="l02144"></a>02144 <span class="comment">     */</span>
<a name="l02145"></a>02145 
<a name="l02146"></a>02146     msg += rlen;
<a name="l02147"></a>02147     msglen -= rlen;
<a name="l02148"></a>02148   } <span class="keywordflow">else</span> {
<a name="l02149"></a>02149     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;found peer\n&quot;</span>);
<a name="l02150"></a>02150   }
<a name="l02151"></a>02151 
<a name="l02152"></a>02152   <span class="comment">/* At this point peer contains a state machine to handle the</span>
<a name="l02153"></a>02153 <span class="comment">     received message. */</span>
<a name="l02154"></a>02154 
<a name="l02155"></a>02155   assert(peer);
<a name="l02156"></a>02156 
<a name="l02157"></a>02157   <span class="comment">/* FIXME: check sequence number of record and drop message if the</span>
<a name="l02158"></a>02158 <span class="comment">   * number is not exactly the last number that we have responded to + 1. </span>
<a name="l02159"></a>02159 <span class="comment">   * Otherwise, stop retransmissions for this specific peer and </span>
<a name="l02160"></a>02160 <span class="comment">   * continue processing. */</span>
<a name="l02161"></a>02161   <a class="code" href="dtls_8c.html#a3bcaa90e5f3f58c6b9b9a2466f7c6707">dtls_stop_retransmission</a>(ctx, peer);
<a name="l02162"></a>02162 
<a name="l02163"></a>02163   <span class="keywordflow">while</span> ((rlen = <a class="code" href="dtls_8c.html#a6ecde1c9d9b4ad41fe6a0b793e205fd2">is_record</a>(msg,msglen))) {
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;got packet %d (%d bytes)\n&quot;</span>, msg[0], rlen);
<a name="l02166"></a>02166     <span class="comment">/* skip packet if it is from a different epoch */</span>
<a name="l02167"></a>02167     <span class="keywordflow">if</span> (memcmp(<a class="code" href="dtls_8c.html#a35d050593196252c1826ac2e82cbac0b">DTLS_RECORD_HEADER</a>(msg)-&gt;epoch, 
<a name="l02168"></a>02168            peer-&gt;<a class="code" href="structdtls__peer__t.html#a9426209cc86fd29402a88fe008a0bc22">epoch</a>, <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>)) != 0)
<a name="l02169"></a>02169       <span class="keywordflow">goto</span> next;
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     <span class="keywordflow">if</span> (!<a class="code" href="dtls_8c.html#a524cdb68e70eb9244579b36c52423eb2">decrypt_verify</a>(peer, msg, rlen, &amp;data, &amp;data_length)) {
<a name="l02172"></a>02172       <a class="code" href="debug_8h.html#a6576e6f80131b01ef1bca232282ef26b">info</a>(<span class="stringliteral">&quot;decrypt_verify() failed\n&quot;</span>);
<a name="l02173"></a>02173       <span class="keywordflow">goto</span> next;
<a name="l02174"></a>02174     }
<a name="l02175"></a>02175 
<a name="l02176"></a>02176 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l02177"></a>02177 <span class="preprocessor"></span>    <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(msg, <span class="keyword">sizeof</span>(<a class="code" href="structdtls__record__header__t.html">dtls_record_header_t</a>));
<a name="l02178"></a>02178     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02179"></a>02179     <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(data, data_length);
<a name="l02180"></a>02180     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02181"></a>02181 <span class="preprocessor">#endif</span>
<a name="l02182"></a>02182 <span class="preprocessor"></span>
<a name="l02183"></a>02183     <span class="comment">/* Handle received record according to the first byte of the</span>
<a name="l02184"></a>02184 <span class="comment">     * message, i.e. the subprotocol. We currently do not support</span>
<a name="l02185"></a>02185 <span class="comment">     * combining multiple fragments of one type into a single</span>
<a name="l02186"></a>02186 <span class="comment">     * record. */</span>
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     <span class="keywordflow">switch</span> (msg[0]) {
<a name="l02189"></a>02189 
<a name="l02190"></a>02190     <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#a3114c327a12e3850e97c4cf8a0cc5c9d">DTLS_CT_CHANGE_CIPHER_SPEC</a>:
<a name="l02191"></a>02191       <a class="code" href="dtls_8c.html#a193a27c41c92947c484e2d96c6a55c02">handle_ccs</a>(ctx, peer, msg, data, data_length);
<a name="l02192"></a>02192       <span class="keywordflow">break</span>;
<a name="l02193"></a>02193 
<a name="l02194"></a>02194     <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#af8ce2230240b6d3c36b216ef459baff1">DTLS_CT_ALERT</a>:
<a name="l02195"></a>02195       <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a028ee7b63487aa7d6e19463f4383dc46">handle_alert</a>(ctx, peer, msg, data, data_length)) {
<a name="l02196"></a>02196     <span class="comment">/* handle alert has invalidated peer */</span>
<a name="l02197"></a>02197     peer = NULL;
<a name="l02198"></a>02198     <span class="keywordflow">return</span> 0;
<a name="l02199"></a>02199       }
<a name="l02200"></a>02200 
<a name="l02201"></a>02201     <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>:
<a name="l02202"></a>02202       <a class="code" href="dtls_8c.html#a3f971dd7bce69824045ec16313b88b8d">handle_handshake</a>(ctx, peer, msg, data, data_length);
<a name="l02203"></a>02203       <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> == <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a953a6aabd0aff0492df164e79815b122">DTLS_STATE_CONNECTED</a>) {
<a name="l02204"></a>02204     <span class="comment">/* stop retransmissions */</span>
<a name="l02205"></a>02205     <a class="code" href="dtls_8c.html#a3bcaa90e5f3f58c6b9b9a2466f7c6707">dtls_stop_retransmission</a>(ctx, peer);
<a name="l02206"></a>02206     <a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, event, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, 0, <a class="code" href="alert_8h.html#a5bed06f27f571d7c7d9b9f212c3a0b22">DTLS_EVENT_CONNECTED</a>);
<a name="l02207"></a>02207       }
<a name="l02208"></a>02208       <span class="keywordflow">break</span>;
<a name="l02209"></a>02209 
<a name="l02210"></a>02210     <span class="keywordflow">case</span> <a class="code" href="dtls_8h.html#a2e3ff1e96b8b7db8a3648beba35bfd0c">DTLS_CT_APPLICATION_DATA</a>:
<a name="l02211"></a>02211       <a class="code" href="debug_8h.html#a6576e6f80131b01ef1bca232282ef26b">info</a>(<span class="stringliteral">&quot;** application data:\n&quot;</span>);
<a name="l02212"></a>02212       <a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(ctx, read, &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, data, data_length);
<a name="l02213"></a>02213       <span class="keywordflow">break</span>;
<a name="l02214"></a>02214     <span class="keywordflow">default</span>:
<a name="l02215"></a>02215       <a class="code" href="debug_8h.html#a6576e6f80131b01ef1bca232282ef26b">info</a>(<span class="stringliteral">&quot;dropped unknown message of type %d\n&quot;</span>,msg[0]);
<a name="l02216"></a>02216     }
<a name="l02217"></a>02217 
<a name="l02218"></a>02218   next:
<a name="l02219"></a>02219     <span class="comment">/* advance msg by length of ciphertext */</span>
<a name="l02220"></a>02220     msg += rlen;
<a name="l02221"></a>02221     msglen -= rlen;
<a name="l02222"></a>02222   }
<a name="l02223"></a>02223 
<a name="l02224"></a>02224   <span class="keywordflow">return</span> 0;
<a name="l02225"></a>02225 }
<a name="l02226"></a>02226 
<a name="l02227"></a>02227 <a class="code" href="structdtls__context__t.html">dtls_context_t</a> *
<a name="l02228"></a><a class="code" href="dtls_8h.html#a11f53d301448aa8f1dbcfaf77441bd9c">02228</a> <a class="code" href="dtls_8c.html#a11f53d301448aa8f1dbcfaf77441bd9c">dtls_new_context</a>(<span class="keywordtype">void</span> *app_data) {
<a name="l02229"></a>02229   <a class="code" href="structdtls__context__t.html">dtls_context_t</a> *c;
<a name="l02230"></a>02230 
<a name="l02231"></a>02231   prng_init(<a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">clock_time</a>()); <span class="comment">/* FIXME: need something better to init PRNG here */</span>
<a name="l02232"></a>02232 
<a name="l02233"></a>02233   c = &amp;<a class="code" href="dtls_8c.html#add05e8b40c758e1a799a281e20873999">the_dtls_context</a>;
<a name="l02234"></a>02234 
<a name="l02235"></a>02235   memset(c, 0, <span class="keyword">sizeof</span>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a>));
<a name="l02236"></a>02236   c-&gt;<a class="code" href="structdtls__context__t.html#ab37722ec6b82dd3120827812f212a51e">app</a> = app_data;
<a name="l02237"></a>02237   
<a name="l02238"></a>02238   <a class="code" href="t__list_8h.html#adcb86fe4485a0f8ea79541117641f730">LIST_STRUCT_INIT</a>(c, sendqueue);
<a name="l02239"></a>02239 
<a name="l02240"></a>02240 <span class="preprocessor">#ifdef WITH_CONTIKI</span>
<a name="l02241"></a>02241 <span class="preprocessor"></span>  <a class="code" href="t__list_8h.html#adcb86fe4485a0f8ea79541117641f730">LIST_STRUCT_INIT</a>(c, peers);
<a name="l02242"></a>02242   <span class="comment">/* LIST_STRUCT_INIT(c, key_store); */</span>
<a name="l02243"></a>02243   
<a name="l02244"></a>02244   process_start(&amp;dtls_retransmit_process, (<span class="keywordtype">char</span> *)c);
<a name="l02245"></a>02245   PROCESS_CONTEXT_BEGIN(&amp;dtls_retransmit_process);
<a name="l02246"></a>02246   <span class="comment">/* the retransmit timer must be initialized to some large value */</span>
<a name="l02247"></a>02247   etimer_set(&amp;c-&gt;retransmit_timer, 0xFFFF);
<a name="l02248"></a>02248   PROCESS_CONTEXT_END(&amp;coap_retransmit_process);
<a name="l02249"></a>02249 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02250"></a>02250 
<a name="l02251"></a>02251   <span class="keywordflow">if</span> (prng(c-&gt;cookie_secret, <a class="code" href="dtls_8h.html#a44ec206b1d84aa3d83281a92ed7cc238">DTLS_COOKIE_SECRET_LENGTH</a>))
<a name="l02252"></a>02252     c-&gt;cookie_secret_age = <a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">clock_time</a>();
<a name="l02253"></a>02253   <span class="keywordflow">else</span> 
<a name="l02254"></a>02254     <span class="keywordflow">goto</span> error;
<a name="l02255"></a>02255   
<a name="l02256"></a>02256   <span class="keywordflow">return</span> c;
<a name="l02257"></a>02257 
<a name="l02258"></a>02258  error:
<a name="l02259"></a>02259   <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da81d3a95073074ab212668a29218cc343">LOG_ALERT</a>, <span class="stringliteral">&quot;cannot create DTLS context&quot;</span>);
<a name="l02260"></a>02260   <span class="keywordflow">if</span> (c)
<a name="l02261"></a>02261     <a class="code" href="dtls_8c.html#a3171c099d25ed29e31326526b8e1de84">dtls_free_context</a>(c);
<a name="l02262"></a>02262   <span class="keywordflow">return</span> NULL;
<a name="l02263"></a>02263 }
<a name="l02264"></a>02264 
<a name="l02265"></a><a class="code" href="dtls_8h.html#a3171c099d25ed29e31326526b8e1de84">02265</a> <span class="keywordtype">void</span> <a class="code" href="dtls_8c.html#a3171c099d25ed29e31326526b8e1de84">dtls_free_context</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx) {
<a name="l02266"></a>02266   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *p;
<a name="l02267"></a>02267   
<a name="l02268"></a>02268 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l02269"></a>02269 <span class="preprocessor"></span>  <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *tmp;
<a name="l02270"></a>02270 
<a name="l02271"></a>02271   <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>) {
<a name="l02272"></a>02272     <a class="code" href="uthash_8h.html#a4d524042f1fcb976d8bccae9e4cc63d6">HASH_ITER</a>(hh, ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, p, tmp) {
<a name="l02273"></a>02273       <a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">dtls_free_peer</a>(p);
<a name="l02274"></a>02274     }
<a name="l02275"></a>02275   }
<a name="l02276"></a>02276 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02277"></a>02277   <span class="keywordtype">int</span> i;
<a name="l02278"></a>02278 
<a name="l02279"></a>02279   p = (<a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *)peer_storage.mem;
<a name="l02280"></a>02280   for (i = 0; i &lt; peer_storage.num; ++i, ++p) {
<a name="l02281"></a>02281     <span class="keywordflow">if</span> (peer_storage.count[i])
<a name="l02282"></a>02282       <a class="code" href="dtls_8c.html#abeff9e25a5b2eb3589f09a4e89b44b78">dtls_free_peer</a>(p);
<a name="l02283"></a>02283   }
<a name="l02284"></a>02284 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02285"></a>02285 }
<a name="l02286"></a>02286 
<a name="l02287"></a>02287 <span class="keywordtype">int</span>
<a name="l02288"></a><a class="code" href="dtls_8h.html#a187f5e145bb869a732fbed426929a4e9">02288</a> <a class="code" href="dtls_8c.html#a187f5e145bb869a732fbed426929a4e9">dtls_connect</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *ctx, <span class="keyword">const</span> session_t *dst) {
<a name="l02289"></a>02289   <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer;
<a name="l02290"></a>02290   <a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *p = ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>;
<a name="l02291"></a>02291   <span class="keywordtype">size_t</span> size;
<a name="l02292"></a>02292   <span class="keywordtype">int</span> res;
<a name="l02293"></a>02293 
<a name="l02294"></a>02294   <span class="comment">/* check if we have DTLS state for addr/port/ifindex */</span>
<a name="l02295"></a>02295 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l02296"></a>02296 <span class="preprocessor"></span>  <a class="code" href="dtls_8c.html#a0ce6e5416f5479558116b881d3eb1ad6">HASH_FIND_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, dst, peer);
<a name="l02297"></a>02297 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02298"></a>02298   <span class="keywordflow">for</span> (peer = <a class="code" href="t__list_8h.html#adb42e31bb4fe0df6ec1aa3494902968d">list_head</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>); peer; peer = <a class="code" href="t__list_8h.html#ae7f0bdad2409695760ffd8de55b6a99b">list_item_next</a>(peer))
<a name="l02299"></a>02299     <span class="keywordflow">if</span> (<a class="code" href="global_8h.html#a72a41dbeec2aa1c999b7f3a38f5b41e5">dtls_session_equals</a>(&amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, dst))
<a name="l02300"></a>02300       <span class="keywordflow">break</span>;
<a name="l02301"></a>02301 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02302"></a>02302   
<a name="l02303"></a>02303   <span class="keywordflow">if</span> (peer) {
<a name="l02304"></a>02304     <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;found peer, try to re-connect\n&quot;</span>);
<a name="l02305"></a>02305     <span class="comment">/* FIXME: send HelloRequest if we are server, </span>
<a name="l02306"></a>02306 <span class="comment">       ClientHello with good cookie if client */</span>
<a name="l02307"></a>02307     <span class="keywordflow">return</span> 0;
<a name="l02308"></a>02308   }
<a name="l02309"></a>02309 
<a name="l02310"></a>02310   peer = <a class="code" href="dtls_8c.html#a24a60717e58c8335b1324ba6ef90601a">dtls_new_peer</a>(ctx, dst);
<a name="l02311"></a>02311 
<a name="l02312"></a>02312   <span class="keywordflow">if</span> (!peer) {
<a name="l02313"></a>02313     <a class="code" href="debug_8c.html#ace8ca7929ecfc486c3ef40828c79bfe5">dsrv_log</a>(<a class="code" href="debug_8h.html#a5cae2fb7fec0dd9e63cf2d755642cd9da3537fbf756308b6267dd4354615eb413">LOG_CRIT</a>, <span class="stringliteral">&quot;cannot create new peer\n&quot;</span>);
<a name="l02314"></a>02314     <span class="keywordflow">return</span> -1;
<a name="l02315"></a>02315   }
<a name="l02316"></a>02316     
<a name="l02317"></a>02317   <span class="comment">/* set peer role to server: */</span>
<a name="l02318"></a>02318   <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;role = <a class="code" href="crypto_8h.html#ae30cd4bcffed73f79f17c09e5a1452c8a7c2a694fc87273c445ad661575b28255">DTLS_SERVER</a>;
<a name="l02319"></a>02319   <a class="code" href="dtls_8c.html#a6b4a43b05999dacdb6ac5150803a88f9">CURRENT_CONFIG</a>(peer)-&gt;role = <a class="code" href="crypto_8h.html#ae30cd4bcffed73f79f17c09e5a1452c8a7c2a694fc87273c445ad661575b28255">DTLS_SERVER</a>;
<a name="l02320"></a>02320 
<a name="l02321"></a>02321 <span class="preprocessor">#ifndef WITH_CONTIKI</span>
<a name="l02322"></a>02322 <span class="preprocessor"></span>  <a class="code" href="dtls_8c.html#acf0d50c9f224c0677988f13e947e9523">HASH_ADD_PEER</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, session, peer);
<a name="l02323"></a>02323 <span class="preprocessor">#else </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02324"></a>02324   <a class="code" href="t__list_8h.html#aee4e6fc5d9a6133555e7373c654b2120">list_add</a>(ctx-&gt;<a class="code" href="structdtls__context__t.html#a417fa8ac04478292f0539d2da0fec088">peers</a>, peer);
<a name="l02325"></a>02325 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02326"></a>02326 
<a name="l02327"></a>02327   <span class="comment">/* send ClientHello with some Cookie */</span>
<a name="l02328"></a>02328 
<a name="l02329"></a>02329   <span class="comment">/* add to size:</span>
<a name="l02330"></a>02330 <span class="comment">   *   1. length of session id (including length field)</span>
<a name="l02331"></a>02331 <span class="comment">   *   2. length of cookie (including length field)</span>
<a name="l02332"></a>02332 <span class="comment">   *   3. cypher suites</span>
<a name="l02333"></a>02333 <span class="comment">   *   4. compression methods </span>
<a name="l02334"></a>02334 <span class="comment">   */</span>
<a name="l02335"></a>02335   size = <a class="code" href="dtls_8c.html#affe47ee08ad0e6a54d4f0c2a7f412675">DTLS_CH_LENGTH</a> + 8;
<a name="l02336"></a>02336 
<a name="l02337"></a>02337   <span class="comment">/* force sending 0 as handshake message sequence number by setting</span>
<a name="l02338"></a>02338 <span class="comment">   * peer to NULL */</span>
<a name="l02339"></a>02339   p = <a class="code" href="dtls_8c.html#ab43d3a34ddaf0f5bfaa2b0b3e76e25d1">dtls_set_handshake_header</a>(<a class="code" href="dtls_8h.html#a25f0afef67a1fd8d9e3e61074d11e2f5">DTLS_HT_CLIENT_HELLO</a>, NULL, 
<a name="l02340"></a>02340                 size, 0, size, p);
<a name="l02341"></a>02341 
<a name="l02342"></a>02342   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="dtls_8h.html#af0c44db3bf3a6a52e9ed271218daeaa6">DTLS_VERSION</a>);
<a name="l02343"></a>02343   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l02344"></a>02344   prng(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random, 
<a name="l02345"></a>02345        <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random));
<a name="l02346"></a>02346   <a class="code" href="numeric_8h.html#a5508498c45a0259b2c02f9bf950fa090">dtls_int_to_uint32</a>(&amp;<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random, <a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">clock_time</a>());
<a name="l02347"></a>02347   memcpy(p, <a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random, 
<a name="l02348"></a>02348      <span class="keyword">sizeof</span>(<a class="code" href="dtls_8c.html#aef133ade7a1f25576fbb41a950a319ca">OTHER_CONFIG</a>(peer)-&gt;client_random));
<a name="l02349"></a>02349   p += 32;
<a name="l02350"></a>02350 
<a name="l02351"></a>02351   <span class="comment">/* session id (length 0) */</span>
<a name="l02352"></a>02352   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, 0);
<a name="l02353"></a>02353   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l02354"></a>02354 
<a name="l02355"></a>02355   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, 0);
<a name="l02356"></a>02356   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l02357"></a>02357 
<a name="l02358"></a>02358   <span class="comment">/* add supported cipher suite */</span>
<a name="l02359"></a>02359   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, 2);
<a name="l02360"></a>02360   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l02361"></a>02361   
<a name="l02362"></a>02362   <a class="code" href="numeric_8h.html#a8b5aff97bf7d3109a84c6e50e44d9ce1">dtls_int_to_uint16</a>(p, <a class="code" href="global_8h.html#ada7e71454d685b693df45b2c1ea0c59ba39a3062f136db88f648ce514a591fac8">TLS_PSK_WITH_AES_128_CCM_8</a>);
<a name="l02363"></a>02363   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#a5e90b30856b81913af89565b55751da5">uint16</a>);
<a name="l02364"></a>02364   
<a name="l02365"></a>02365   <span class="comment">/* compression method */</span>
<a name="l02366"></a>02366   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, 1);  
<a name="l02367"></a>02367   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l02368"></a>02368 
<a name="l02369"></a>02369   <a class="code" href="numeric_8h.html#a5879046be8f4d320c0f2471a89de2f2a">dtls_int_to_uint8</a>(p, <a class="code" href="dtls_8h.html#a9b0d69c07ce606ae4293939acd07be47">TLS_COMP_NULL</a>);
<a name="l02370"></a>02370   p += <span class="keyword">sizeof</span>(<a class="code" href="global_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>);
<a name="l02371"></a>02371 
<a name="l02372"></a>02372   res = <a class="code" href="dtls_8c.html#af5f2c908d9510284b3f25fd7f4965997">dtls_send</a>(ctx, peer, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>, 
<a name="l02373"></a>02373           p - ctx-&gt;<a class="code" href="structdtls__context__t.html#a01ca6e3b266e42753e0325b01f23600a">sendbuf</a>);
<a name="l02374"></a>02374   <span class="keywordflow">if</span> (res &lt; 0)
<a name="l02375"></a>02375     <a class="code" href="debug_8h.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;cannot send ClientHello\n&quot;</span>);
<a name="l02376"></a>02376   <span class="keywordflow">else</span> 
<a name="l02377"></a>02377     peer-&gt;<a class="code" href="structdtls__peer__t.html#a4e23cc3b273813744524c3db1fda9c83">state</a> = <a class="code" href="dtls_8h.html#aea0e57fd5b857535960534b53361aa35a1a76f1e49c80d22df9673f8471d1ec53">DTLS_STATE_CLIENTHELLO</a>;
<a name="l02378"></a>02378 
<a name="l02379"></a>02379   <span class="keywordflow">return</span> res;
<a name="l02380"></a>02380 }
<a name="l02381"></a>02381 
<a name="l02382"></a>02382 <span class="keywordtype">void</span>
<a name="l02383"></a><a class="code" href="dtls_8c.html#ad23ff3b83fa5993de2f09551d68f0635">02383</a> <a class="code" href="dtls_8c.html#ad23ff3b83fa5993de2f09551d68f0635">dtls_retransmit</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *context, <a class="code" href="structnetq__t.html">netq_t</a> *node) {
<a name="l02384"></a>02384   <span class="keywordflow">if</span> (!context || !node)
<a name="l02385"></a>02385     <span class="keywordflow">return</span>;
<a name="l02386"></a>02386 
<a name="l02387"></a>02387   <span class="comment">/* re-initialize timeout when maximum number of retransmissions are not reached yet */</span>
<a name="l02388"></a>02388   <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structnetq__t.html#aacd03017f40248c2f48c2b7b9cd92dc8">retransmit_cnt</a> &lt; DTLS_DEFAULT_MAX_RETRANSMIT) {
<a name="l02389"></a>02389       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sendbuf[DTLS_MAX_BUF];
<a name="l02390"></a>02390       <span class="keywordtype">size_t</span> len = <span class="keyword">sizeof</span>(sendbuf);
<a name="l02391"></a>02391 
<a name="l02392"></a>02392       node-&gt;<a class="code" href="structnetq__t.html#aacd03017f40248c2f48c2b7b9cd92dc8">retransmit_cnt</a>++;
<a name="l02393"></a>02393       node-&gt;<a class="code" href="structnetq__t.html#afe91256ff5267fc680b96efd3bd8635a">t</a> += (node-&gt;<a class="code" href="structnetq__t.html#ae0c2648acf87d1e6f2566bc3600771b6">timeout</a> &lt;&lt; node-&gt;<a class="code" href="structnetq__t.html#aacd03017f40248c2f48c2b7b9cd92dc8">retransmit_cnt</a>);
<a name="l02394"></a>02394       <a class="code" href="group__netq.html#ga8045aa49152a3c97c65ef6dbb03e1295">netq_insert_node</a>((<a class="code" href="structnetq__t.html">netq_t</a> **)context-&gt;sendqueue, node);
<a name="l02395"></a>02395       
<a name="l02396"></a>02396       <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;** retransmit packet\n&quot;</span>);
<a name="l02397"></a>02397       
<a name="l02398"></a>02398       <span class="keywordflow">if</span> (<a class="code" href="dtls_8c.html#a3dfa15f20cc7ddae5d1140c4bf3eb6fa">dtls_prepare_record</a>(node-&gt;<a class="code" href="structnetq__t.html#aaca5f6407bd7b3162d9ee7e7e7b8f0ff">peer</a>, <a class="code" href="dtls_8h.html#a76965db5ec449b3c8a9a54c24a4d45dc">DTLS_CT_HANDSHAKE</a>, 
<a name="l02399"></a>02399                   node-&gt;<a class="code" href="structnetq__t.html#a13f460c7491e57bc97abcf87953e4ab9">data</a>, node-&gt;<a class="code" href="structnetq__t.html#ac72c9378282becab5a273f612f58c124">length</a>, 
<a name="l02400"></a>02400                   sendbuf, &amp;len) &gt; 0) {
<a name="l02401"></a>02401     
<a name="l02402"></a>02402 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l02403"></a>02403 <span class="preprocessor"></span>    <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;retransmit %d bytes\n&quot;</span>, len);
<a name="l02404"></a>02404     <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(sendbuf, <span class="keyword">sizeof</span>(<a class="code" href="structdtls__record__header__t.html">dtls_record_header_t</a>));
<a name="l02405"></a>02405     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02406"></a>02406     <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(node-&gt;<a class="code" href="structnetq__t.html#a13f460c7491e57bc97abcf87953e4ab9">data</a>, node-&gt;<a class="code" href="structnetq__t.html#ac72c9378282becab5a273f612f58c124">length</a>);
<a name="l02407"></a>02407     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02408"></a>02408 <span class="preprocessor">#endif</span>
<a name="l02409"></a>02409 <span class="preprocessor"></span>    
<a name="l02410"></a>02410     (void)<a class="code" href="dtls_8c.html#a3e132aba78de736930255d40ef3f2d34">CALL</a>(context, write, &amp;node-&gt;<a class="code" href="structnetq__t.html#aaca5f6407bd7b3162d9ee7e7e7b8f0ff">peer</a>-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>, sendbuf, len);
<a name="l02411"></a>02411       }
<a name="l02412"></a>02412       <span class="keywordflow">return</span>;
<a name="l02413"></a>02413   }
<a name="l02414"></a>02414 
<a name="l02415"></a>02415   <span class="comment">/* no more retransmissions, remove node from system */</span>
<a name="l02416"></a>02416   
<a name="l02417"></a>02417   <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;** removed transaction\n&quot;</span>);
<a name="l02418"></a>02418 
<a name="l02419"></a>02419   <span class="comment">/* And finally delete the node */</span>
<a name="l02420"></a>02420   <a class="code" href="group__netq.html#ga9ef9da1a2af266dadef83ddf6c8524d7">netq_node_free</a>(node);
<a name="l02421"></a>02421 }
<a name="l02422"></a>02422 
<a name="l02423"></a>02423 <span class="keywordtype">void</span>
<a name="l02424"></a><a class="code" href="dtls_8c.html#a3bcaa90e5f3f58c6b9b9a2466f7c6707">02424</a> <a class="code" href="dtls_8c.html#a3bcaa90e5f3f58c6b9b9a2466f7c6707">dtls_stop_retransmission</a>(<a class="code" href="structdtls__context__t.html">dtls_context_t</a> *context, <a class="code" href="structdtls__peer__t.html">dtls_peer_t</a> *peer) {
<a name="l02425"></a>02425   <span class="keywordtype">void</span> *node;
<a name="l02426"></a>02426   node = <a class="code" href="t__list_8h.html#adb42e31bb4fe0df6ec1aa3494902968d">list_head</a>((<a class="code" href="t__list_8h.html#a9c248916bae1f0b13732686786be7108">list_t</a>)context-&gt;sendqueue); 
<a name="l02427"></a>02427 
<a name="l02428"></a>02428   <span class="keywordflow">while</span> (node) {
<a name="l02429"></a>02429     <span class="keywordflow">if</span> (<a class="code" href="global_8h.html#a72a41dbeec2aa1c999b7f3a38f5b41e5">dtls_session_equals</a>(&amp;((<a class="code" href="structnetq__t.html">netq_t</a> *)node)-&gt;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>,
<a name="l02430"></a>02430                 &amp;peer-&gt;<a class="code" href="structdtls__peer__t.html#a44ebb2ba643269c7e6943f3a9040febe">session</a>)) {
<a name="l02431"></a>02431       <span class="keywordtype">void</span> *tmp = node;
<a name="l02432"></a>02432       node = <a class="code" href="t__list_8h.html#ae7f0bdad2409695760ffd8de55b6a99b">list_item_next</a>(node);
<a name="l02433"></a>02433       <a class="code" href="t__list_8h.html#a10de2120be61f445c5989c983c1e133b">list_remove</a>((<a class="code" href="t__list_8h.html#a9c248916bae1f0b13732686786be7108">list_t</a>)context-&gt;sendqueue, tmp);
<a name="l02434"></a>02434       <a class="code" href="group__netq.html#ga9ef9da1a2af266dadef83ddf6c8524d7">netq_node_free</a>((<a class="code" href="structnetq__t.html">netq_t</a> *)tmp);
<a name="l02435"></a>02435     } <span class="keywordflow">else</span>
<a name="l02436"></a>02436       node = <a class="code" href="t__list_8h.html#ae7f0bdad2409695760ffd8de55b6a99b">list_item_next</a>(node);    
<a name="l02437"></a>02437   }
<a name="l02438"></a>02438 }
<a name="l02439"></a>02439 
<a name="l02440"></a>02440 <span class="preprocessor">#ifdef WITH_CONTIKI</span>
<a name="l02441"></a>02441 <span class="preprocessor"></span><span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l02442"></a>02442 <span class="comment">/* message retransmission */</span>
<a name="l02443"></a>02443 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l02444"></a>02444 <a class="code" href="dtls-client_8c.html#a233413ccb00ec94d7142f7180e62fc20">PROCESS_THREAD</a>(dtls_retransmit_process, ev, data)
<a name="l02445"></a>02445 {
<a name="l02446"></a>02446   <a class="code" href="global_8h.html#a0fd31305d371cbf278caae964f751146">clock_time_t</a> now;
<a name="l02447"></a>02447   <a class="code" href="structnetq__t.html">netq_t</a> *node;
<a name="l02448"></a>02448 
<a name="l02449"></a>02449   PROCESS_BEGIN();
<a name="l02450"></a>02450 
<a name="l02451"></a>02451   <a class="code" href="debug_8h.html#a86ee3ff44c537d94ccbabf941a613688">debug</a>(<span class="stringliteral">&quot;Started DTLS retransmit process\r\n&quot;</span>);
<a name="l02452"></a>02452 
<a name="l02453"></a>02453   <span class="keywordflow">while</span>(1) {
<a name="l02454"></a>02454     PROCESS_YIELD();
<a name="l02455"></a>02455     <span class="keywordflow">if</span> (ev == PROCESS_EVENT_TIMER) {
<a name="l02456"></a>02456       <span class="keywordflow">if</span> (etimer_expired(&amp;the_dtls_context.retransmit_timer)) {
<a name="l02457"></a>02457     
<a name="l02458"></a>02458     node = <a class="code" href="t__list_8h.html#adb42e31bb4fe0df6ec1aa3494902968d">list_head</a>(the_dtls_context.sendqueue);
<a name="l02459"></a>02459     
<a name="l02460"></a>02460     now = <a class="code" href="dtls_8c.html#ab844c429da2b3da5cedb3ae3b7f4272c">clock_time</a>();
<a name="l02461"></a>02461     <span class="keywordflow">while</span> (node &amp;&amp; node-&gt;<a class="code" href="structnetq__t.html#afe91256ff5267fc680b96efd3bd8635a">t</a> &lt;= now) {
<a name="l02462"></a>02462       <a class="code" href="dtls_8c.html#ad23ff3b83fa5993de2f09551d68f0635">dtls_retransmit</a>(&amp;the_dtls_context, <a class="code" href="t__list_8h.html#a5ba6a8506e0226ab945349e25ef65d56">list_pop</a>(the_dtls_context.sendqueue));
<a name="l02463"></a>02463       node = <a class="code" href="t__list_8h.html#adb42e31bb4fe0df6ec1aa3494902968d">list_head</a>(the_dtls_context.sendqueue);
<a name="l02464"></a>02464     }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <span class="comment">/* need to set timer to some value even if no nextpdu is available */</span>
<a name="l02467"></a>02467     etimer_set(&amp;the_dtls_context.retransmit_timer, 
<a name="l02468"></a>02468            node ? node-&gt;<a class="code" href="structnetq__t.html#afe91256ff5267fc680b96efd3bd8635a">t</a> - now : 0xFFFF);
<a name="l02469"></a>02469       } 
<a name="l02470"></a>02470     }
<a name="l02471"></a>02471   }
<a name="l02472"></a>02472   
<a name="l02473"></a>02473   PROCESS_END();
<a name="l02474"></a>02474 }
<a name="l02475"></a>02475 <span class="preprocessor">#endif </span><span class="comment">/* WITH_CONTIKI */</span>
<a name="l02476"></a>02476 
<a name="l02477"></a>02477 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l02478"></a>02478 <span class="preprocessor"></span>
<a name="l02479"></a><a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">02479</a> <span class="keywordtype">void</span> <a class="code" href="dtls_8c.html#af5fe8134d8875eb856a4cd99313ec1b0">hexdump</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *packet, <span class="keywordtype">int</span> length) {
<a name="l02480"></a>02480   <span class="keywordtype">int</span> n = 0;
<a name="l02481"></a>02481 
<a name="l02482"></a>02482   <span class="keywordflow">while</span> (length--) { 
<a name="l02483"></a>02483     <span class="keywordflow">if</span> (n % 16 == 0)
<a name="l02484"></a>02484       printf(<span class="stringliteral">&quot;%08X &quot;</span>,n);
<a name="l02485"></a>02485 
<a name="l02486"></a>02486     printf(<span class="stringliteral">&quot;%02X &quot;</span>, *packet++);
<a name="l02487"></a>02487     
<a name="l02488"></a>02488     n++;
<a name="l02489"></a>02489     <span class="keywordflow">if</span> (n % 8 == 0) {
<a name="l02490"></a>02490       <span class="keywordflow">if</span> (n % 16 == 0)
<a name="l02491"></a>02491     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02492"></a>02492       <span class="keywordflow">else</span>
<a name="l02493"></a>02493     printf(<span class="stringliteral">&quot; &quot;</span>);
<a name="l02494"></a>02494     }
<a name="l02495"></a>02495   }
<a name="l02496"></a>02496 }
<a name="l02497"></a>02497 
<a name="l02499"></a><a class="code" href="dtls_8c.html#a7ee74b9f3941b0ec63f35da6b83fa240">02499</a> <span class="keywordtype">void</span> <a class="code" href="crypto_8c.html#a0687f17f3913c35371d897a972f515aa">dump</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="dtls-client_8c.html#a095f0dd49eb8681e3a9d4632a98bb06e">buf</a>, <span class="keywordtype">size_t</span> len) {
<a name="l02500"></a>02500   <span class="keywordflow">while</span> (len--) 
<a name="l02501"></a>02501     printf(<span class="stringliteral">&quot;%02x&quot;</span>, *buf++);
<a name="l02502"></a>02502 }
<a name="l02503"></a>02503 <span class="preprocessor">#endif</span>
<a name="l02504"></a>02504 <span class="preprocessor"></span>
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Jul 12 2012 11:52:35 for tinydtls by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
